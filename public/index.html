<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>カンパーニュ予約（CORS解決版）</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh; line-height: 1.6; color: #333;
    }
    .container { 
      max-width: 900px; margin: 24px auto; padding: 20px; 
      background: #fff; border-radius: 16px; 
      box-shadow: 0 10px 40px rgba(0,0,0,.1); 
    }
    h1 {
      text-align: center; font-size: 2.4rem; margin-bottom: 30px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; font-weight: 700;
    }
    h2 {
      font-size: 1.6rem; color: #4a5568; border-bottom: 3px solid #e2e8f0;
      padding-bottom: 12px; margin: 32px 0 20px; position: relative;
    }
    h2::before {
      content: ''; position: absolute; bottom: -3px; left: 0; width: 60px; height: 3px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    }
    label { 
      display: block; margin: 16px 0 8px; font-weight: 600; color: #2d3748; font-size: 14px;
    }
    input, select {
      width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 10px;
      font-size: 16px; margin-top: 6px; transition: all 0.3s ease; font-family: inherit;
      background: #fafafa;
    }
    input:focus, select:focus {
      outline: none; border-color: #667eea; background: #fff;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); transform: translateY(-1px);
    }
    small { display: block; margin-top: 6px; font-size: 12px; color: #718096; line-height: 1.4; }
    section {
      margin: 32px 0; padding: 24px; background: #f7fafc; border-radius: 12px;
      border: 1px solid #e2e8f0; position: relative; overflow: hidden;
    }
    section::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    }
    .grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 16px; margin-top: 20px;
    }
    .card { 
      border: 2px solid #e2e8f0; padding: 20px; border-radius: 12px; 
      background: white; transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(45deg, #48bb78 0%, #38a169 100%);
      transform: scaleX(0); transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    .card:hover::before { transform: scaleX(1); }
    .card h3 { margin: 0 0 12px; font-size: 18px; color: #2d3748; font-weight: 600; }
    .card > div { color: #4a5568; font-size: 16px; margin-bottom: 16px; font-weight: 500; }
    .qty { width: 80px; text-align: center; margin-top: 8px; font-weight: 600; }
    .total { 
      font-size: 24px; font-weight: 700; margin-top: 20px; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border-radius: 12px; text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button { 
      width: 100%; padding: 18px 32px; border: none; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: 600;
      margin-top: 32px; transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    button:disabled { 
      background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none;
    }
    button.loading { position: relative; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; top: 50%; left: 50%; 
      transform: translate(-50%, -50%); width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .toast { 
      margin-top: 20px; padding: 16px 20px; border-radius: 10px; font-weight: 500;
      border-left: 4px solid; animation: slideIn 0.3s ease-out;
    }
    .toast:not(.error):not(.warning) { 
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      color: #22543d; border-left-color: #38a169;
    }
    .toast.error { 
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      color: #742a2a; border-left-color: #e53e3e;
    }
    .toast.warning { 
      background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
      color: #744210; border-left-color: #d69e2e;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ステータス表示 */
    .status-card {
      background: white; border-radius: 10px; padding: 16px; margin: 16px 0;
      border-left: 4px solid; font-weight: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .status-loading {
      border-left-color: #3182ce;
      background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); color: #2c5282;
    }
    .status-success {
      border-left-color: #38a169;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); color: #22543d;
    }
    .status-error {
      border-left-color: #e53e3e;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); color: #742a2a;
    }

    /* デバッグ情報 */
    .debug-info {
      background: #f7fafc; border: 2px solid #e2e8f0; padding: 20px; margin: 20px 0;
      border-radius: 10px; font-size: 12px; color: #4a5568; max-height: 400px; overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    .debug-info h3 { margin: 0 0 16px; color: #2d3748; font-size: 16px; font-family: inherit; }
    .debug-info .log-entry {
      margin: 6px 0; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.6);
      border-left: 3px solid #e2e8f0; font-size: 11px; line-height: 1.4;
    }
    .debug-info .log-entry.error { border-left-color: #e53e3e; background: rgba(254, 178, 178, 0.3); }
    .debug-info .log-entry.warn { border-left-color: #d69e2e; background: rgba(250, 240, 137, 0.3); }

    /* 予約完了画面 */
    .success-screen {
      text-align: center; padding: 40px 20px;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
      border-radius: 16px; border: 3px solid #38a169; margin: 20px 0;
      animation: fadeIn 0.6s ease-out;
    }
    .success-icon {
      font-size: 4rem; color: #38a169; margin-bottom: 20px; display: block;
      animation: bounce 0.8s ease-out;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .success-screen h2 {
      color: #22543d; font-size: 2.2rem; margin-bottom: 20px; border: none;
    }
    .reservation-details {
      background: white; padding: 24px; border-radius: 12px; margin: 24px 0;
      border: 2px solid #c6f6d5; text-align: left;
    }
    .detail-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid #e2e8f0;
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 600; color: #2d3748; }
    .detail-value { color: #4a5568; font-weight: 500; }

    /* レスポンシブ */
    @media (max-width: 768px) {
      .container { margin: 12px; padding: 16px; }
      h1 { font-size: 2rem; }
      .grid { grid-template-columns: 1fr; }
      .detail-row { flex-direction: column; align-items: flex-start; gap: 6px; }
    }

    .hidden { display: none; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <main class="container">
    <!-- 予約フォーム画面 -->
    <div id="reservationForm">
      <h1>🍞 カンパーニュ受取予約フォーム</h1>

      <!-- システム状態表示 -->
      <div id="systemStatus" class="status-card status-loading">
        🔄 システム初期化中... (CORS回避モード)
      </div>

      <!-- デバッグ情報（初期は非表示）-->
      <div id="debugInfo" class="debug-info hidden">
        <h3>🔧 システム診断情報</h3>
        <div id="debugContent"></div>
      </div>

      <section>
        <h2>📅 受取日時の選択</h2>
        <label>受取日（水・土のみ）<span style="color: #e53e3e;">*</span>
          <input type="date" id="pickupDate" required />
          <small id="dateHelp">営業日（水曜日・土曜日）かつ臨時休業日以外を選択してください</small>
        </label>
        
        <label>受取時間（11:00–17:00）<span style="color: #e53e3e;">*</span>
          <select id="pickupTime" required>
            <option value="">時間を選択してください</option>
          </select>
          <small id="timeHelp">先に受取日を選択してください</small>
        </label>
        
        <label>支払方法<span style="color: #e53e3e;">*</span>
          <select id="paymentMethod" required>
            <option value="cash">💰 現金</option>
            <option value="paypay">📱 PayPay</option>
          </select>
          <small>店頭でのお支払い方法を選択してください</small>
        </label>
      </section>

      <section>
        <h2>🛒 商品を選択</h2>
        <div id="productStatus" class="status-card status-loading">📦 商品データを読み込み中...</div>
        <div id="productList" class="grid"></div>
        <div class="total">合計: ¥<span id="total">0</span></div>
      </section>

      <section>
        <h2>👤 お客様情報</h2>
        <label>お名前<span style="color: #e53e3e;">*</span>
          <input id="custName" placeholder="山田太郎" required />
          <small>フルネームでご入力ください</small>
        </label>
        
        <label>メールアドレス<span style="color: #e53e3e;">*</span>
          <input id="custEmail" type="email" placeholder="taro@example.com" required />
          <small>確認メールをお送りしますので、正確にご入力ください</small>
        </label>
        
        <label>電話番号（任意）
          <input id="custPhone" type="tel" placeholder="090-1234-5678" />
          <small>緊急連絡時にのみ使用いたします</small>
        </label>
        
        <label>備考（任意）
          <input id="notes" placeholder="アレルギーやご要望などございましたらご記入ください" />
          <small>特別なご要望があればお書きください</small>
        </label>
      </section>

      <button id="submitBtn" disabled>🔄 システム準備中...</button>
      
      <div id="toast" class="toast hidden"></div>

      <!-- デバッグ切り替えボタン -->
      <div class="text-center" style="margin-top: 20px;">
        <button type="button" onclick="toggleDebug()" style="width: auto; padding: 8px 16px; font-size: 12px; background: #718096;">
          🔍 システム診断情報の表示切り替え
        </button>
      </div>
    </div>

    <!-- 予約完了画面 -->
    <div id="successScreen" class="hidden">
      <div class="success-screen">
        <span class="success-icon">✅</span>
        <h2>予約完了いたしました！</h2>
        <p>ご予約ありがとうございます。以下の内容で承りました。</p>
        
        <div class="reservation-details">
          <h3>📋 予約詳細</h3>
          <div class="detail-row">
            <span class="detail-label">予約番号:</span>
            <span class="detail-value" id="successReserveNo">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">お名前:</span>
            <span class="detail-value" id="successName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">受取日時:</span>
            <span class="detail-value" id="successDateTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">お支払い:</span>
            <span class="detail-value" id="successPayment">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">合計金額:</span>
            <span class="detail-value" id="successTotal">-</span>
          </div>
        </div>

        <div class="reservation-details">
          <h3>📧 確認メール</h3>
          <div id="mailStatus">📮 メール送信状況を確認中...</div>
        </div>

        <div class="reservation-details">
          <h3>📍 店舗情報</h3>
          <p><strong>受取場所:</strong> カンパーニュ</p>
          <p><strong>営業日:</strong> 水曜日・土曜日</p>
          <p><strong>営業時間:</strong> 11:00～17:00</p>
          <div style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 14px; color: #4a5568;">
            ⚠️ <strong>重要:</strong> 当日お気をつけてお越しください<br>
            💡 ご不明な点がございましたら、確認メールに記載の連絡先までお問い合わせください
          </div>
        </div>

        <button onclick="backToForm()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
          🔙 新しい予約をする
        </button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // ★★★ システム設定 ★★★
    const firebaseConfig = {
      apiKey: "AIzaSyC7e6YZSeh1RYBdWEfob6xT7XnxBIZu2Uw",
      authDomain: "hyggelyreservationsystem.firebaseapp.com",
      projectId: "hyggelyreservationsystem",
      storageBucket: "hyggelyreservationsystem.firebasestorage.app",
      messagingSenderId: "549459143900",
      appId: "1:549459143900:web:7d9f2bb6ddc22573869819"
    };

    // ★★★ GAS設定（実際のURLに変更してください）★★★
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyC-0emy2ecJnc8cSFCWIOuPpr41cNr8yWjj2-bZ8i6_3-fu45-Q1ys9R2IQUIhkihD/exec";
    const GAS_API_KEY = "91d012136acf47f0b65ca8f84aceced56af240e21d3f42878f6e535dfe03a625";

    // ★★★ グローバル変数 ★★★
    let debugMode = false;
    let systemLogs = [];
    let db;
    let systemReady = false;
    let products = [];
    let holidays = new Set();
    let cart = {};

    // DOM要素
    const elements = {
      date: document.getElementById('pickupDate'),
      time: document.getElementById('pickupTime'),
      payment: document.getElementById('paymentMethod'),
      productList: document.getElementById('productList'),
      total: document.getElementById('total'),
      custName: document.getElementById('custName'),
      custEmail: document.getElementById('custEmail'),
      custPhone: document.getElementById('custPhone'),
      notes: document.getElementById('notes'),
      submitBtn: document.getElementById('submitBtn'),
      toast: document.getElementById('toast')
    };

    // ★★★ ログ・デバッグ機能 ★★★
    function log(message, level = 'info') {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const logEntry = { time: timestamp, level: level, message: String(message), timestamp: Date.now() };
      systemLogs.push(logEntry);
      console.log(`[${level.toUpperCase()}] ${timestamp}: ${message}`);
      if (systemLogs.length > 100) systemLogs = systemLogs.slice(-80);
      if (debugMode) updateDebugDisplay();
    }
    
    function updateDebugDisplay() {
      const debugContent = document.getElementById('debugContent');
      if (!debugContent) return;
      const recentLogs = systemLogs.slice(-30);
      debugContent.innerHTML = recentLogs.map(entry => {
        const levelClass = entry.level === 'error' ? 'error' : entry.level === 'warn' ? 'warn' : '';
        return `<div class="log-entry ${levelClass}">[${entry.time}] ${escapeHtml(entry.message)}</div>`;
      }).join('');
      debugContent.scrollTop = debugContent.scrollHeight;
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.classList.toggle('hidden', !debugMode);
        if (debugMode) updateDebugDisplay();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('systemStatus');
      const productStatusEl = document.getElementById('productStatus');
      
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `status-card status-${type}`;
      }
      
      if (productStatusEl && type !== 'loading') {
        productStatusEl.textContent = type === 'success' ? '✅ 商品一覧' : message;
        productStatusEl.className = `status-card status-${type}`;
      }
      
      log(`Status: ${message} (${type})`);
    }

    // ★★★ Firebase初期化 ★★★
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      log('Firebase初期化完了');
    } catch (error) {
      log(`Firebase初期化エラー: ${error.message}`, 'error');
      updateStatus('❌ データベース接続に失敗しました', 'error');
    }

    // ★★★ CORS完全回避 GAS通信機能 ★★★
    let requestCounter = 0;

    function sendToGAS_JSONP(path, data) {
      return new Promise((resolve) => {
        try {
          log(`JSONP通信開始: ${path}`);
          
          const callbackName = `gasCallback_${Date.now()}_${++requestCounter}`;
          const timeoutId = setTimeout(() => {
            cleanup();
            log('JSONP通信タイムアウト', 'warn');
            resolve({
              ok: false,
              method: 'jsonp_timeout',
              message: 'リクエストタイムアウト'
            });
          }, 15000);
          
          // グローバルコールバック関数を作成
          window[callbackName] = (response) => {
            cleanup();
            log('JSONP通信成功');
            resolve({
              ...response,
              method: 'jsonp_success'
            });
          };
          
          function cleanup() {
            clearTimeout(timeoutId);
            if (window[callbackName]) {
              delete window[callbackName];
            }
            const existingScript = document.getElementById(callbackName);
            if (existingScript) {
              existingScript.remove();
            }
          }
          
          // リクエストURL構築
          const params = new URLSearchParams({
            key: GAS_API_KEY,
            path: path,
            data: JSON.stringify(data),
            callback: callbackName
          });
          
          // スクリプトタグ作成・実行
          const script = document.createElement('script');
          script.id = callbackName;
          script.src = `${GAS_ENDPOINT}?${params.toString()}`;
          script.onerror = () => {
            cleanup();
            log('JSONP通信スクリプトエラー', 'error');
            resolve({
              ok: false,
              method: 'jsonp_script_error',
              message: 'スクリプト読み込みエラー'
            });
          };
          
          document.head.appendChild(script);
          
        } catch (error) {
          log(`JSONP通信エラー: ${error.message}`, 'error');
          resolve({
            ok: false,
            method: 'jsonp_exception',
            error: error.message
          });
        }
      });
    }

    // フォーム送信によるフォールバック
    function sendToGAS_Form(path, data) {
      return new Promise((resolve) => {
        try {
          log(`フォーム送信通信開始: ${path}`);
          
          // 隠しiframe作成
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.name = `gasFrame_${Date.now()}`;
          
          // フォーム作成
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = GAS_ENDPOINT;
          form.target = iframe.name;
          
          // パラメータ追加
          const params = {
            key: GAS_API_KEY,
            path: path,
            data: JSON.stringify(data)
          };
          
          Object.entries(params).forEach(([key, value]) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
          });
          
          // イベントハンドラ設定
          const timeoutId = setTimeout(() => {
            cleanup();
            log('フォーム送信タイムアウト', 'warn');
            resolve({
              ok: false,
              method: 'form_timeout',
              message: 'フォーム送信タイムアウト'
            });
          }, 10000);
          
          iframe.onload = () => {
            cleanup();
            log('フォーム送信完了');
            resolve({
              ok: true,
              method: 'form_success',
              message: 'フォーム送信が完了しました'
            });
          };
          
          function cleanup() {
            clearTimeout(timeoutId);
            if (iframe.parentNode) iframe.remove();
            if (form.parentNode) form.remove();
          }
          
          // 実行
          document.body.appendChild(iframe);
          document.body.appendChild(form);
          form.submit();
          
        } catch (error) {
          log(`フォーム送信エラー: ${error.message}`, 'error');
          resolve({
            ok: false,
            method: 'form_exception',
            error: error.message
          });
        }
      });
    }

    // メイン通信関数（複数手法併用）
    async function sendToGAS(path, data, maxRetries = 2) {
      const methods = [
        () => sendToGAS_JSONP(path, data),
        () => sendToGAS_Form(path, data)
      ];
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        for (const [index, method] of methods.entries()) {
          try {
            log(`通信試行 ${attempt}/${maxRetries}, 手法 ${index + 1}/${methods.length}`);
            const result = await method();
            
            if (result.ok) {
              log(`通信成功: ${path} (${result.method})`);
              return result;
            } else {
              log(`通信失敗: ${result.message} (${result.method})`, 'warn');
            }
            
          } catch (error) {
            log(`通信例外: ${error.message}`, 'error');
          }
        }
        
        if (attempt < maxRetries) {
          log(`${1000 * attempt}ms 待機後にリトライ`);
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
      
      log(`全通信手法が失敗: ${path}`, 'error');
      return {
        ok: false,
        method: 'all_failed',
        message: 'すべての通信方法が失敗しました'
      };
    }

    // ★★★ ビジネスロジック関数 ★★★
    function isBusinessDay(dateStr, holidaysSet) {
      try {
        const d = new Date(dateStr + 'T00:00:00+09:00');
        const dayOfWeek = d.getDay();
        if (holidaysSet && holidaysSet.has(dateStr)) {
          log(`${dateStr} は臨時休業日です`);
          return false;
        }
        const isBusiness = dayOfWeek === 3 || dayOfWeek === 6;
        log(`${dateStr} 曜日:${dayOfWeek} 営業日:${isBusiness}`);
        return isBusiness;
      } catch (error) {
        log(`営業日判定エラー: ${error.message}`, 'error');
        return false;
      }
    }

    function generateTimeSlots(start = "11:00", end = "17:00", intervalMin = 30) {
      try {
        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);
        const startMinutes = startH * 60 + startM;
        const endMinutes = endH * 60 + endM;
        
        const slots = [];
        for (let minutes = startMinutes; minutes <= endMinutes; minutes += intervalMin) {
          const hours = String(Math.floor(minutes / 60)).padStart(2, '0');
          const mins = String(minutes % 60).padStart(2, '0');
          slots.push(`${hours}:${mins}`);
        }
        
        log(`時間スロット生成: ${slots.length}個 (${slots[0]} - ${slots[slots.length-1]})`);
        return slots;
      } catch (error) {
        log(`時間スロット生成エラー: ${error.message}`, 'error');
        return [];
      }
    }

    // ★★★ システム初期化 ★★★
    async function initializeSystem() {
      try {
        log('🚀 システム初期化開始 (CORS回避モード)');
        updateStatus('🔗 データベース接続テスト中...', 'loading');
        
        await testFirebaseConnection();
        
        log('📅 休業日データ取得開始');
        await loadHolidays();
        
        log('🛍️ 商品データ取得開始');
        await loadProducts();
        
        setupEventListeners();
        
        systemReady = true;
        updateStatus('✅ システム準備完了 (CORS回避モード)', 'success');
        elements.submitBtn.disabled = false;
        elements.submitBtn.textContent = '📝 予約を確定する';
        
        log('✅ システム初期化完了');
        showToast('システムの準備が完了しました。ご予約をお進めください。', false);
        
      } catch (error) {
        log(`❌ システム初期化エラー: ${error.message}`, 'error');
        updateStatus(`❌ システムエラー: ${error.message}`, 'error');
        showToast(`システム初期化に失敗しました: ${error.message}`, true);
      }
    }

    async function testFirebaseConnection() {
      try {
        log('🔍 Firebase接続テスト開始');
        const testQuery = await db.collection('products').limit(1).get();
        log(`✅ Firebase接続成功 - プロジェクト: ${firebase.app().options.projectId}`);
        log(`📊 テストクエリ結果: ${testQuery.size}件のドキュメント`);
      } catch (error) {
        log(`❌ Firebase接続エラー: ${error.message}`, 'error');
        throw new Error(`データベース接続に失敗: ${error.message}`);
      }
    }

    async function loadHolidays() {
      try {
        const snapshot = await db.collection('holidays').get();
        holidays.clear();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.date) holidays.add(data.date);
        });
        log(`📅 休業日データ取得完了: ${holidays.size}件`);
        if (holidays.size > 0) {
          log(`休業日リスト: ${Array.from(holidays).join(', ')}`);
        }
      } catch (error) {
        log(`⚠️ 休業日データ取得エラー: ${error.message}`, 'error');
        log('休業日データなしで続行します');
      }
    }

    async function loadProducts() {
      try {
        log('🔍 商品データクエリ実行中...');
        updateStatus('📦 商品データを読み込み中...', 'loading');
        
        const snapshot = await db.collection('products').get();
        log(`📦 商品データ取得: ${snapshot.size}件`);
        
        const allProducts = [];
        snapshot.forEach(doc => {
          allProducts.push({ id: doc.id, ...doc.data() });
        });
        
        products = allProducts
          .filter(p => p.enabled === true)
          .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
        
        log(`🎯 有効商品: ${products.length}件`);
        
        if (products.length === 0) {
          throw new Error('有効な商品が見つかりません');
        }
        
        renderProducts();
        updateStatus('✅ 商品データ読み込み完了', 'success');
        
      } catch (error) {
        log(`❌ 商品データ取得エラー: ${error.message}`, 'error');
        updateStatus(`❌ 商品取得エラー: ${error.message}`, 'error');
        throw error;
      }
    }

    function renderProducts() {
      try {
        log('🎨 商品リスト描画開始');
        elements.productList.innerHTML = '';
        
        if (products.length === 0) {
          elements.productList.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
              📦 商品データがありません
            </div>
          `;
          return;
        }
        
        products.forEach(product => {
          if (product.price <= 0) {
            log(`⚠️ 価格0円商品をスキップ: ${product.name}`);
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>🍞 ${escapeHtml(product.name)}</h3>
            <div>¥${product.price.toLocaleString()}</div>
            <label>数量 
              <input type="number" min="0" max="20" value="0" class="qty" data-id="${product.id}">
            </label>
          `;
          
          elements.productList.appendChild(card);
          log(`✅ 商品カード作成: ${product.name}`);
        });
        
        elements.productList.querySelectorAll('.qty').forEach(input => {
          input.addEventListener('input', handleQuantityChange);
        });
        
        log(`🎨 商品リスト描画完了: ${products.length}件`);
        
      } catch (error) {
        log(`❌ 商品リスト描画エラー: ${error.message}`, 'error');
        elements.productList.innerHTML = `
          <div style="grid-column: 1/-1;" class="status-card status-error">
            商品リスト表示エラー: ${escapeHtml(error.message)}
          </div>
        `;
      }
    }

    function setupEventListeners() {
      log('🔧 イベントリスナー設定開始');
      elements.date.addEventListener('change', handleDateChange);
      elements.payment.addEventListener('change', calculateTotal);
      elements.submitBtn.addEventListener('click', handleSubmit);
      log('✅ イベントリスナー設定完了');
    }

    function handleDateChange() {
      try {
        const selectedDate = elements.date.value;
        const timeHelp = document.getElementById('timeHelp');
        
        log(`📅 受取日選択: ${selectedDate}`);
        
        elements.time.innerHTML = '<option value="">時間を選択してください</option>';
        
        if (!selectedDate) {
          timeHelp.textContent = '先に受取日を選択してください';
          timeHelp.style.color = '#718096';
          return;
        }
        
        if (!isBusinessDay(selectedDate, holidays)) {
          timeHelp.textContent = '❌ 営業日（水・土）かつ臨時休業日以外を選択してください';
          timeHelp.style.color = '#e53e3e';
          showToast('営業日（水曜日・土曜日）かつ臨時休業日以外を選択してください', true);
          return;
        }
        
        const timeSlots = generateTimeSlots();
        log(`⏰ 時間スロット生成: ${timeSlots.length}個`);
        
        timeSlots.forEach(timeSlot => {
          const option = document.createElement('option');
          option.value = timeSlot;
          option.textContent = timeSlot;
          elements.time.appendChild(option);
        });
        
        timeHelp.textContent = '✅ 受取時間を選択してください';
        timeHelp.style.color = '#38a169';
        
      } catch (error) {
        log(`❌ 受取日変更エラー: ${error.message}`, 'error');
        showToast(`日付処理エラー: ${error.message}`, true);
      }
    }

    function handleQuantityChange(event) {
      try {
        const input = event.target;
        const productId = input.dataset.id;
        const quantity = Math.max(0, Math.min(20, Number(input.value || 0)));
        
        input.value = quantity;
        
        if (quantity === 0) {
          delete cart[productId];
        } else {
          cart[productId] = quantity;
        }
        
        calculateTotal();
        log(`🛒 商品数量変更: ${productId} = ${quantity}`);
        
      } catch (error) {
        log(`❌ 数量変更エラー: ${error.message}`, 'error');
      }
    }

    function calculateTotal() {
      try {
        let totalAmount = 0;
        let totalItems = 0;
        
        Object.entries(cart).forEach(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          if (product) {
            totalAmount += product.price * quantity;
            totalItems += quantity;
          }
        });
        
        elements.total.textContent = totalAmount.toLocaleString();
        log(`💰 合計金額: ¥${totalAmount.toLocaleString()} (${totalItems}点)`);
        
      } catch (error) {
        log(`❌ 合計計算エラー: ${error.message}`, 'error');
        elements.total.textContent = '0';
      }
    }

    function validateForm() {
      if (!systemReady) throw new Error('システムが準備中です。しばらくお待ちください');
      if (!elements.date.value || !isBusinessDay(elements.date.value, holidays)) throw new Error('有効な受取日を選択してください');
      if (!elements.time.value) throw new Error('受取時間を選択してください');
      
      const now = new Date();
      const pickupDateTime = new Date(`${elements.date.value}T${elements.time.value}:00+09:00`);
      if (pickupDateTime <= now) throw new Error('過去の日時は選択できません');
      
      if (!['cash', 'paypay'].includes(elements.payment.value)) throw new Error('支払方法を選択してください');
      if (!elements.custName.value.trim()) throw new Error('お名前を入力してください');
      
      const email = elements.custEmail.value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('正しいメールアドレスを入力してください');
      
      if (Object.keys(cart).length === 0) throw new Error('商品を1点以上選択してください');
      
      log('✅ フォームバリデーション成功');
    }

    async function handleSubmit() {
      try {
        log('📝 予約送信処理開始');
        
        elements.submitBtn.disabled = true;
        elements.submitBtn.classList.add('loading');
        elements.submitBtn.textContent = '';
        
        validateForm();
        
        const orderItems = Object.entries(cart).map(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          return {
            product_id: productId,
            name: product.name,
            unit_price: product.price,
            qty: quantity,
            line_total: product.price * quantity
          };
        });
        
        const totalAmount = orderItems.reduce((sum, item) => sum + item.line_total, 0);
        
        const reservationData = {
          items: orderItems,
          subtotal: totalAmount,
          total: totalAmount,
          payment_method: elements.payment.value,
          pickup_date: elements.date.value,
          pickup_time: elements.time.value,
          pickup_ts: firebase.firestore.Timestamp.fromDate(
            new Date(`${elements.date.value}T${elements.time.value}:00+09:00`)
          ),
          status: 'reserved',
          customer: {
            name: elements.custName.value.trim(),
            email: elements.custEmail.value.trim(),
            phone: elements.custPhone.value.trim() || null
          },
          notes: elements.notes.value.trim() || null,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        log(`📋 予約データ作成完了: ${elements.date.value} ${elements.time.value}, 合計¥${totalAmount.toLocaleString()}`);
        
        log('💾 Firestore保存開始');
        const docRef = await db.collection('reservations').add(reservationData);
        const reserveNo = `R-${elements.date.value.replace(/-/g,'')}-${docRef.id.slice(0,5)}`;
        await docRef.update({ reserve_no: reserveNo });
        
        log(`✅ 予約保存完了: ${reserveNo}`);
        
        let mailResult = { success: false, message: '送信中...' };
        let reminderResult = { success: false, message: '設定中...' };
        
        // GAS API並行呼び出し
        const gasRequests = [
          sendToGAS('mail', {
            reserve_no: reserveNo,
            customer: reservationData.customer,
            pickup: { 
              date: reservationData.pickup_date, 
              time: reservationData.pickup_time 
            },
            items: orderItems,
            total: totalAmount,
            payment_method: reservationData.payment_method
          }).then(result => {
            mailResult = {
              success: result.ok,
              message: result.ok ? '送信完了' : `送信失敗: ${result.message || 'Unknown error'}`,
              method: result.method || 'unknown'
            };
            log(`📧 メール送信結果: ${JSON.stringify(mailResult)}`);
          }).catch(error => {
            mailResult = { success: false, message: `送信エラー: ${error.message}` };
            log(`📧 メール送信エラー: ${error.message}`, 'error');
          }),
          
          sendToGAS('remind', {
            reserve_no: reserveNo,
            customer: reservationData.customer,
            pickup: { 
              date: reservationData.pickup_date, 
              time: reservationData.pickup_time 
            }
          }).then(result => {
            reminderResult = {
              success: result.ok,
              message: result.ok ? '設定完了' : `設定失敗: ${result.message || 'Unknown error'}`,
              method: result.method || 'unknown'
            };
            log(`🔔 リマインダー結果: ${JSON.stringify(reminderResult)}`);
          }).catch(error => {
            reminderResult = { success: false, message: `設定エラー: ${error.message}` };
            log(`🔔 リマインダー設定エラー: ${error.message}`, 'error');
          })
        ];
        
        await Promise.allSettled([
          Promise.race([
            Promise.all(gasRequests),
            new Promise(resolve => setTimeout(resolve, 15000))
          ])
        ]);
        
        log('🎉 予約処理完了');
        
        showSuccessScreen({
          reserveNo: reserveNo,
          customerName: reservationData.customer.name,
          pickupDate: reservationData.pickup_date,
          pickupTime: reservationData.pickup_time,
          paymentMethod: reservationData.payment_method === 'cash' ? '現金' : 'PayPay',
          totalAmount: totalAmount.toLocaleString(),
          mailResult: mailResult,
          reminderResult: reminderResult
        });
        
        resetForm();
        
      } catch (error) {
        log(`❌ 予約送信エラー: ${error.message}`, 'error');
        showToast(`予約に失敗しました: ${error.message}`, true);
        
      } finally {
        elements.submitBtn.disabled = false;
        elements.submitBtn.classList.remove('loading');
        elements.submitBtn.textContent = '📝 予約を確定する';
      }
    }

    function showSuccessScreen(data) {
      document.getElementById('successReserveNo').textContent = data.reserveNo;
      document.getElementById('successName').textContent = data.customerName;
      document.getElementById('successDateTime').textContent = `${data.pickupDate} ${data.pickupTime}`;
      document.getElementById('successPayment').textContent = data.paymentMethod;
      document.getElementById('successTotal').textContent = `¥${data.totalAmount}`;
      
      const mailStatusEl = document.getElementById('mailStatus');
      if (data.mailResult && data.mailResult.success) {
        mailStatusEl.innerHTML = `
          <div style="color: #22543d; font-weight: 500;">
            ✅ ご入力いただいたメールアドレスに確認メールをお送りしました
          </div>
        `;
      } else {
        mailStatusEl.innerHTML = `
          <div style="color: #d69e2e; padding: 12px; background: #fefcbf; border-radius: 8px; border: 1px solid #f6e05e;">
            ⚠️ 確認メールの送信で問題が発生しました<br>
            ${escapeHtml(data.mailResult?.message || '送信状況不明')}<br>
            <small style="color: #744210;">※予約は正常に完了しておりますので、ご安心ください</small>
          </div>
        `;
      }
      
      document.getElementById('reservationForm').classList.add('hidden');
      document.getElementById('successScreen').classList.remove('hidden');
      window.scrollTo(0, 0);
    }
    
    function backToForm() {
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('reservationForm').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    function resetForm() {
      cart = {};
      document.querySelectorAll('.qty').forEach(input => input.value = 0);
      calculateTotal();
      
      elements.date.value = '';
      elements.time.innerHTML = '<option value="">時間を選択してください</option>';
      elements.custName.value = '';
      elements.custEmail.value = '';
      elements.custPhone.value = '';
      elements.notes.value = '';
      
      const dateHelp = document.getElementById('dateHelp');
      const timeHelp = document.getElementById('timeHelp');
      if (dateHelp) {
        dateHelp.textContent = '営業日（水曜日・土曜日）かつ臨時休業日以外を選択してください';
        dateHelp.style.color = '#718096';
      }
      if (timeHelp) {
        timeHelp.textContent = '先に受取日を選択してください';
        timeHelp.style.color = '#718096';
      }
    }

    function showToast(message, isError = false, duration = 8000) {
      elements.toast.textContent = message;
      elements.toast.classList.remove('hidden');
      elements.toast.className = `toast ${isError ? 'error' : ''}`;
      
      setTimeout(() => {
        elements.toast.classList.add('hidden');
      }, duration);
      
      log(`📢 トースト: ${message}`, isError ? 'error' : 'info');
    }

    // システム開始
    document.addEventListener('DOMContentLoaded', () => {
      log('📄 DOM読み込み完了 - CORS回避モード');
      initializeSystem().catch(error => {
        log(`💥 初期化失敗: ${error.message}`, 'error');
        showToast(`システム初期化に失敗しました: ${error.message}`, true);
      });
    });
  </script>
</body>
</html>