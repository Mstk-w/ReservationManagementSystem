<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>„Ç´„É≥„Éë„Éº„Éã„É•‰∫àÁ¥Ñ</title>
  <style>
    /* =========================== */
    /* Âü∫Êú¨„Çπ„Çø„Ç§„É´ÔºàÂÖÉ„ÅÆstyle.css + Êã°ÂºµÔºâ */
    /* =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fafafa; 
      line-height: 1.6;
      color: #333;
    }

    .container { 
      max-width: 900px; 
      margin: 24px auto; 
      padding: 16px; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 2px 12px rgba(0,0,0,.06); 
    }

    h1, h2 { 
      margin: 8px 0 16px; 
      color: #2d6cdf;
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 24px;
    }

    h2 {
      font-size: 1.5rem;
      border-bottom: 2px solid #e8f4fd;
      padding-bottom: 8px;
      margin-top: 32px;
    }

    label { 
      display: block; 
      margin: 8px 0;
      font-weight: 500;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 4px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2d6cdf;
      box-shadow: 0 0 0 3px rgba(45, 108, 223, 0.1);
    }

    small {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }

    section {
      margin: 24px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
      gap: 12px; 
      margin-top: 16px;
    }

    .card { 
      border: 1px solid #e1e8ed; 
      padding: 16px; 
      border-radius: 10px; 
      background: white;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .card h3 { 
      margin: 0 0 8px; 
      font-size: 16px; 
      color: #2d6cdf;
      font-weight: 600;
    }

    .card > div {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .qty { 
      width: 70px; 
      text-align: center;
      margin-top: 4px;
    }

    .total { 
      font-size: 20px; 
      font-weight: bold; 
      margin-top: 16px;
      padding: 16px;
      background: #e8f4fd;
      border-radius: 8px;
      text-align: center;
      color: #2d6cdf;
    }

    button { 
      width: 100%;
      padding: 16px 24px; 
      border: none; 
      background: #2d6cdf; 
      color: #fff; 
      border-radius: 8px; 
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 24px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: #1e4ba8;
      transform: translateY(-1px);
    }

    button:disabled { 
      background: #999; 
      cursor: not-allowed;
      transform: none;
    }

    button.loading { 
      opacity: .7; 
      pointer-events: none; 
    }

    .toast { 
      margin-top: 16px; 
      padding: 16px; 
      border-radius: 8px; 
      background: #d4edda; 
      color: #155724;
      border: 1px solid #c3e6cb;
      font-weight: 500;
    }

    .toast.error { 
      background: #f8d7da; 
      color: #721c24;
      border-color: #f5c6cb;
    }

    .toast.warning { 
      background: #fff3cd; 
      color: #856404;
      border-color: #ffeaa7;
    }

    /* =========================== */
    /* „Éá„Éê„ÉÉ„Ç∞„Éª„Çπ„ÉÜ„Éº„Çø„ÇπÁî®„Çπ„Çø„Ç§„É´ */
    /* =========================== */
    .debug-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      font-size: 12px;
      color: #0d47a1;
      max-height: 300px;
      overflow-y: auto;
    }

    .debug-info h3 {
      margin: 0 0 12px;
      color: #1565c0;
      font-size: 14px;
    }

    .debug-info div {
      margin: 4px 0;
      padding: 2px 0;
      border-bottom: 1px solid rgba(33, 150, 243, 0.1);
      font-family: monospace;
    }

    .error-info {
      background: #ffebee;
      border: 1px solid #f44336;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #c62828;
      font-weight: 500;
    }

    .loading {
      background: #fff3e0;
      border: 1px solid #ff9800;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #e65100;
      font-weight: 500;
      text-align: center;
    }

    .success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #2e7d32;
      font-weight: 500;
      text-align: center;
    }

    #productList.loading::after {
      content: "üì¶ ÂïÜÂìÅ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...";
      display: block;
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }

    /* =========================== */
    /* ‰∫àÁ¥ÑÂÆå‰∫ÜÁîªÈù¢„Çπ„Çø„Ç§„É´ */
    /* =========================== */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-radius: 16px;
      border: 2px solid #4caf50;
      margin: 20px 0;
    }

    .success-screen h2 {
      color: #2e7d32;
      font-size: 2rem;
      margin-bottom: 20px;
      border: none;
    }

    .success-icon {
      font-size: 4rem;
      color: #4caf50;
      margin-bottom: 20px;
      display: block;
    }

    .reservation-details {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid #c8e6c9;
    }

    .reservation-details h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e8f5e9;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: #2e7d32;
    }

    .detail-value {
      color: #1b5e20;
    }

    .back-button {
      background: #4caf50;
      margin-top: 20px;
    }

    .back-button:hover:not(:disabled) {
      background: #388e3c;
    }

    .warning-notice {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      color: #856404;
      font-size: 14px;
    }

    /* =========================== */
    /* „Éú„Çø„É≥ËøΩÂä†„Çπ„Çø„Ç§„É´ */
    /* =========================== */
    .btn-secondary {
      background: #6c757d;
      color: white;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin: 10px 0;
      display: inline-block;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }

    /* =========================== */
    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    /* =========================== */
    @media (max-width: 768px) {
      .container {
        margin: 12px;
        padding: 12px;
      }

      h1 {
        font-size: 1.8rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      section {
        padding: 16px;
      }

      button {
        padding: 14px 20px;
      }

      .success-screen h2 {
        font-size: 1.6rem;
      }

      .success-icon {
        font-size: 3rem;
      }

      .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 8px;
        padding: 8px;
      }

      h1 {
        font-size: 1.6rem;
      }

      section {
        padding: 12px;
      }

      input, select {
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* =========================== */
    /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    /* =========================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes checkmark {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .container {
      animation: fadeIn 0.5s ease-out;
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    .success-screen {
      animation: fadeIn 0.6s ease-out;
    }

    .success-icon {
      animation: checkmark 0.8s ease-out;
    }

    /* =========================== */
    /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„ÇØ„É©„Çπ */
    /* =========================== */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }

    .hidden { display: none; }

    /* =========================== */
    /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É™„É≥„Ç∞ */
    /* =========================== */
    .debug-info::-webkit-scrollbar {
      width: 6px;
    }

    .debug-info::-webkit-scrollbar-track {
      background: rgba(33, 150, 243, 0.1);
      border-radius: 3px;
    }

    .debug-info::-webkit-scrollbar-thumb {
      background: rgba(33, 150, 243, 0.3);
      border-radius: 3px;
    }

    .debug-info::-webkit-scrollbar-thumb:hover {
      background: rgba(33, 150, 243, 0.5);
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- ‰∫àÁ¥Ñ„Éï„Ç©„Éº„É†ÁîªÈù¢ -->
    <div id="reservationForm">
      <h1>üçû „Ç´„É≥„Éë„Éº„Éã„É•ÂèóÂèñ‰∫àÁ¥Ñ„Éï„Ç©„Éº„É†</h1>

      <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢ -->
      <div id="debugInfo" class="debug-info hidden">
        <h3>üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</h3>
        <div id="debugContent"></div>
      </div>

      <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫ -->
      <div id="systemStatus" class="loading">
        üì° „Ç∑„Çπ„ÉÜ„É†Êé•Á∂ö„ÇíÁ¢∫Ë™ç‰∏≠...
      </div>

      <section>
        <h2>üìÖ ÂèóÂèñÊó•ÊôÇ„ÅÆÈÅ∏Êäû</h2>
        <label>ÂèóÂèñÊó•ÔºàÊ∞¥„ÉªÂúü„ÅÆ„ÅøÔºâ
          <input type="date" id="pickupDate" />
          <small id="dateHelp">Âñ∂Ê•≠Êó•ÔºàÊ∞¥ÊõúÊó•„ÉªÂúüÊõúÊó•Ôºâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
        </label>
        
        <label>ÂèóÂèñÊôÇÈñìÔºà11:00‚Äì17:00Ôºâ
          <select id="pickupTime">
            <option value="">ÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          </select>
          <small id="timeHelp">ÂÖà„Å´ÂèóÂèñÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
        </label>
        
        <label>ÊîØÊâïÊñπÊ≥ï
          <select id="paymentMethod">
            <option value="cash">üí∞ ÁèæÈáë</option>
            <option value="paypay">üì± PayPay</option>
          </select>
        </label>
      </section>

      <section>
        <h2>üõí ÂïÜÂìÅ„ÇíÈÅ∏Êäû</h2>
        <div id="productStatus" class="loading">ÂïÜÂìÅ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        <div id="productList" class="grid loading"></div>
        <div class="total">ÂêàË®à: ¬•<span id="total">0</span></div>
      </section>

      <section>
        <h2>üë§ „ÅäÂÆ¢ÊßòÊÉÖÂ†±</h2>
        <label>Ê∞èÂêç <span style="color: #e74c3c;">*</span>
          <input id="custName" placeholder="Â±±Áî∞Â§™ÈÉé" required />
        </label>
        
        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ <span style="color: #e74c3c;">*</span>
          <input id="custEmail" type="email" placeholder="taro@example.com" required />
        </label>
        
        <label>ÈõªË©±Áï™Âè∑Ôºà‰ªªÊÑèÔºâ
          <input id="custPhone" type="tel" placeholder="090-1234-5678" />
        </label>
        
        <label>ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ
          <input id="notes" placeholder="„Ç¢„É¨„É´„ÇÆ„Éº„ÇÑ„ÅîË¶ÅÊúõ„Å™„Å©„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„Çâ„ÅîË®òÂÖ•„Åè„Å†„Åï„ÅÑ" />
        </label>
      </section>

      <button id="submitBtn" disabled>„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...</button>
      
      <div id="toast" class="toast hidden"></div>

      <!-- Ë©≥Á¥∞„É≠„Ç∞Ë°®Á§∫Âàá„ÇäÊõø„Åà -->
      <button type="button" onclick="toggleDebug()" class="btn-secondary">
        üîç „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫Âàá„ÇäÊõø„Åà
      </button>
    </div>

    <!-- ‰∫àÁ¥ÑÂÆå‰∫ÜÁîªÈù¢ -->
    <div id="successScreen" class="hidden">
      <div class="success-screen">
        <span class="success-icon">‚úÖ</span>
        <h2>‰∫àÁ¥ÑÂÆå‰∫Ü„ÅÑ„Åü„Åó„Åæ„Åó„ÅüÔºÅ</h2>
        <p>„Åî‰∫àÁ¥Ñ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂÜÖÂÆπ„ÅßÊâø„Çä„Åæ„Åó„Åü„ÄÇ</p>
        
        <div class="reservation-details">
          <h3>üìã ‰∫àÁ¥ÑË©≥Á¥∞</h3>
          <div class="detail-row">
            <span class="detail-label">‰∫àÁ¥ÑÁï™Âè∑:</span>
            <span class="detail-value" id="successReserveNo">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">„ÅäÂêçÂâç:</span>
            <span class="detail-value" id="successName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ÂèóÂèñÊó•ÊôÇ:</span>
            <span class="detail-value" id="successDateTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">„ÅäÊîØÊâï„ÅÑ:</span>
            <span class="detail-value" id="successPayment">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ÂêàË®àÈáëÈ°ç:</span>
            <span class="detail-value" id="successTotal">-</span>
          </div>
        </div>

        <div class="reservation-details">
          <h3>üìß Á¢∫Ë™ç„É°„Éº„É´</h3>
          <div id="mailStatus"></div>
        </div>

        <div class="reservation-details">
          <h3>üìç Â∫óËàóÊÉÖÂ†±</h3>
          <p><strong>ÂèóÂèñÂ†¥ÊâÄ:</strong> „Ç´„É≥„Éë„Éº„Éã„É•</p>
          <p><strong>Âñ∂Ê•≠Êó•:</strong> Ê∞¥ÊõúÊó•„ÉªÂúüÊõúÊó•</p>
          <p><strong>Âñ∂Ê•≠ÊôÇÈñì:</strong> 11:00ÔΩû17:00</p>
          <p style="margin-top: 10px; color: #666; font-size: 14px;">
            ‚Äª ÂΩìÊó•„ÅäÊ∞ó„Çí„Å§„Åë„Å¶„ÅäË∂ä„Åó„Åè„Å†„Åï„ÅÑ<br>
            ‚Äª „Åî‰∏çÊòé„Å™ÁÇπ„Åå„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„Çâ„ÄÅÁ¢∫Ë™ç„É°„Éº„É´„Å´Ë®òËºâ„ÅÆÈÄ£Áµ°ÂÖà„Åæ„Åß„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ
          </p>
        </div>

        <button class="back-button" onclick="backToForm()">üîô Êñ∞„Åó„ÅÑ‰∫àÁ¥Ñ„Çí„Åô„Çã</button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // ‚òÖFirebaseË®≠ÂÆöÔºà‰øÆÊ≠£ÁâàÔºâ
    const firebaseConfig = {
      apiKey: "AIzaSyC7e6YZSeh1RYBdWEfob6xT7XnxBIZu2Uw",
      authDomain: "hyggelyreservationsystem.firebaseapp.com",
      projectId: "hyggelyreservationsystem",
      storageBucket: "hyggelyreservationsystem.firebasestorage.app",
      messagingSenderId: "549459143900",
      appId: "1:549459143900:web:7d9f2bb6ddc22573869819"
    };

    // „Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ
    let debugMode = false;
    let debugLogs = [];
    
    function debugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
      debugLogs.push(logEntry);
      console.log(logEntry);
      
      if (debugMode) {
        updateDebugDisplay();
      }
    }
    
    function updateDebugDisplay() {
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        debugContent.innerHTML = debugLogs.slice(-20).map(log => `<div>${escapeHtml(log)}</div>`).join('');
      }
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.classList.toggle('hidden', !debugMode);
        if (debugMode) updateDebugDisplay();
      }
    }

    // ÁîªÈù¢Âàá„ÇäÊõø„Åà
    function showSuccessScreen() {
      document.getElementById('reservationForm').classList.add('hidden');
      document.getElementById('successScreen').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    function backToForm() {
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('reservationForm').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // FirebaseÂàùÊúüÂåñ
    try {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      debugLog('FirebaseÂàùÊúüÂåñÊàêÂäü');
    } catch (error) {
      debugLog(`FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, 'error');
      updateSystemStatus('‚ùå FirebaseÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }

    // ‚òÖGASË®≠ÂÆö
    window.GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzqQsqyFmV6HC0l174c73TM4bwhni0hleo2M7-rSoltVoxAjFODwFJQsoJlMaNe_hUv/exec";
    window.GAS_API_KEY  = "91d012136acf47f0b65ca8f84aceced56af240e21d3f42878f6e535dfe03a625";

    // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫Êõ¥Êñ∞
    function updateSystemStatus(message, type = 'loading') {
      const statusEl = document.getElementById('systemStatus');
      const productStatusEl = document.getElementById('productStatus');
      
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = type;
      }
      
      if (productStatusEl && type !== 'loading') {
        productStatusEl.textContent = type === 'success' ? '‚úÖ ÂïÜÂìÅ‰∏ÄË¶ß' : message;
        productStatusEl.className = type;
      }
    }

    // ÊôÇÈñìÈñ¢ÈÄ£„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
    function isBusinessDay(dateStr, holidaysSet) {
      try {
        const d = new Date(dateStr + 'T00:00:00+09:00');
        const wd = d.getDay(); // 0=Êó•..6=Âúü
        if (holidaysSet && holidaysSet.has(dateStr)) {
          debugLog(`${dateStr}„ÅØËá®ÊôÇ‰ºëÊ•≠Êó•„Åß„Åô`);
          return false;
        }
        const isBusiness = wd === 3 || wd === 6; // Ê∞¥Êõú(3)„ÉªÂúüÊõú(6)
        debugLog(`${dateStr} ÊõúÊó•:${wd} Âñ∂Ê•≠Êó•:${isBusiness}`);
        return isBusiness;
      } catch (error) {
        debugLog(`Âñ∂Ê•≠Êó•Âà§ÂÆö„Ç®„É©„Éº: ${error.message}`, 'error');
        return false;
      }
    }

    function genTimeSlots(open = "11:00", close = "17:00", stepMin = 30) {
      try {
        const [oh, om] = open.split(':').map(Number);
        const [ch, cm] = close.split(':').map(Number);
        let start = oh * 60 + om, end = ch * 60 + cm;
        const slots = [];
        for (let m = start; m <= end; m += stepMin) {
          const hh = String(Math.floor(m / 60)).padStart(2, '0');
          const mm = String(m % 60).padStart(2, '0');
          slots.push(`${hh}:${mm}`);
        }
        debugLog(`ÊôÇÈñì„Çπ„É≠„ÉÉ„ÉàÁîüÊàê: ${slots.length}‰ª∂ (${slots[0]} - ${slots[slots.length-1]})`);
        return slots;
      } catch (error) {
        debugLog(`ÊôÇÈñì„Çπ„É≠„ÉÉ„ÉàÁîüÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
        return [];
      }
    }

    // HTML„Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ‚òÖ‚òÖ‚òÖ CORSÂØæÂøú„ÅÆGASÈÄö‰ø°Èñ¢Êï∞ ‚òÖ‚òÖ‚òÖ
    async function sendToGAS(path, data, retries = 2) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          debugLog(`GASÈÄö‰ø°Ë©¶Ë°å ${attempt}/${retries}: ${path}`);
          
          // ÊñπÊ≥ï1: FormData‰ΩøÁî®Ôºàpreflight„ÇíÈÅø„Åë„ÇãÔºâ
          const formData = new FormData();
          formData.append('key', GAS_API_KEY);
          formData.append('path', path);
          formData.append('data', JSON.stringify(data));
          
          const response = await fetch(GAS_ENDPOINT, {
            method: 'POST',
            body: formData,
            mode: 'cors',
            credentials: 'omit'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          debugLog(`GASÈÄö‰ø°ÊàêÂäü: ${path} - ${JSON.stringify(result)}`);
          return result;
          
        } catch (error) {
          debugLog(`GASÈÄö‰ø°Â§±Êïó ${attempt}/${retries}: ${error.message}`, 'error');
          
          if (attempt === retries) {
            // ÊúÄÂæå„ÅÆË©¶Ë°å„Åß„ÇÇÂ§±Êïó„Åó„ÅüÂ†¥Âêà
            debugLog(`GASÈÄö‰ø°ÊúÄÁµÇÂ§±Êïó: ${path}`, 'error');
            
            // CORS„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÂà•„ÅÆÊñπÊ≥ï„ÇíË©¶Ë°å
            if (error.message.includes('CORS') || error.message.includes('fetch')) {
              return await sendToGASFallback(path, data);
            }
            
            throw error;
          }
          
          // „É™„Éà„É©„Ç§Ââç„Å´Â∞ë„ÅóÂæÖÊ©ü
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
    }

    // ‚òÖ‚òÖ‚òÖ GASÈÄö‰ø°„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàGETÊñπÂºèÔºâ‚òÖ‚òÖ‚òÖ
    async function sendToGASFallback(path, data) {
      try {
        debugLog(`GAS„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈÄö‰ø°: ${path}`);
        
        // GET„Éë„É©„É°„Éº„Çø„ÅßÈÄÅ‰ø°ÔºàCORS„ÇíÂõûÈÅøÔºâ
        const params = new URLSearchParams({
          key: GAS_API_KEY,
          path: path,
          data: JSON.stringify(data)
        });
        
        const url = `${GAS_ENDPOINT}?${params.toString()}`;
        
        // imgË¶ÅÁ¥†„Çí‰ΩøÁî®„Åó„ÅüÈùûÂêåÊúüÈÄö‰ø°ÔºàCORS„ÇíÂÆåÂÖ®„Å´ÂõûÈÅøÔºâ
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            debugLog(`GAS„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈÄö‰ø°ÂÆå‰∫Ü: ${path}`);
            resolve({ ok: true, method: 'fallback' });
          };
          img.onerror = () => {
            debugLog(`GAS„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈÄö‰ø°„Ç®„É©„Éº: ${path}`, 'error');
            resolve({ ok: false, method: 'fallback', error: 'image_load_failed' });
          };
          img.src = url;
          
          // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
          setTimeout(() => {
            debugLog(`GAS„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈÄö‰ø°„Çø„Ç§„É†„Ç¢„Ç¶„Éà: ${path}`, 'error');
            resolve({ ok: false, method: 'fallback', error: 'timeout' });
          }, 10000);
        });
        
      } catch (error) {
        debugLog(`GAS„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈÄö‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
        return { ok: false, method: 'fallback', error: error.message };
      }
    }
  </script>

  <!-- „É°„Ç§„É≥„É≠„Ç∏„ÉÉ„ÇØ -->
  <script>
    const els = {
      date:  document.getElementById('pickupDate'),
      time:  document.getElementById('pickupTime'),
      pm:    document.getElementById('paymentMethod'),
      list:  document.getElementById('productList'),
      total: document.getElementById('total'),
      name:  document.getElementById('custName'),
      email: document.getElementById('custEmail'),
      phone: document.getElementById('custPhone'),
      notes: document.getElementById('notes'),
      btn:   document.getElementById('submitBtn'),
      toast: document.getElementById('toast'),
    };

    let products = []; // {id,name,price,enabled,seasonal,sort_order}
    let holidays = new Set();
    let cart = {};     // {productId: qty}
    let systemReady = false;

    const db = window.db;
    const GAS_ENDPOINT = window.GAS_ENDPOINT;
    const GAS_API_KEY  = window.GAS_API_KEY;

    // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
    async function init() {
      try {
        debugLog('üöÄ „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
        updateSystemStatus('üì° „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÇíÁ¢∫Ë™ç‰∏≠...', 'loading');

        // Êé•Á∂ö„ÉÜ„Çπ„Éà
        await testFirebaseConnection();
        
        // ‰ºëÊó•ÂèñÂæó
        debugLog('üìÖ ‰ºëÊ•≠Êó•„Éá„Éº„ÇøÂèñÂæóÈñãÂßã');
        await loadHolidays();
        
        // ÂïÜÂìÅÂèñÂæó
        debugLog('üõçÔ∏è ÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæóÈñãÂßã');
        await loadProducts();
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        setupEventListeners();
        
        // „Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü
        systemReady = true;
        updateSystemStatus('‚úÖ „Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü', 'success');
        els.btn.disabled = false;
        els.btn.textContent = 'üìù ‰∫àÁ¥Ñ„Åô„Çã';
        
        debugLog('‚úÖ „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        
      } catch (error) {
        debugLog(`‚ùå „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, 'error');
        updateSystemStatus(`‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message}`, 'error');
        showToast(`„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`, true);
      }
    }

    // FirebaseÊé•Á∂ö„ÉÜ„Çπ„Éà
    async function testFirebaseConnection() {
      try {
        debugLog('üîó FirebaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñãÂßã');
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±ÂèñÂæó„ÉÜ„Çπ„Éà
        const testDoc = await db.collection('products').limit(1).get();
        debugLog(`‚úÖ FirebaseÊé•Á∂öÊàêÂäü - „Éó„É≠„Ç∏„Çß„ÇØ„Éà: ${firebase.app().options.projectId}`);
        debugLog(`üìä Êé•Á∂ö„ÉÜ„Çπ„ÉàÁµêÊûú: ${testDoc.size}‰ª∂„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæó`);
        
      } catch (error) {
        debugLog(`‚ùå FirebaseÊé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}`, 'error');
        throw new Error(`„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
      }
    }

    // ‰ºëÊ•≠Êó•„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    async function loadHolidays() {
      try {
        const hs = await db.collection('holidays').get();
        holidays.clear();
        hs.forEach(d => holidays.add(d.data().date));
        debugLog(`üìÖ ‰ºëÊ•≠Êó•„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü: ${holidays.size}‰ª∂`);
        if (holidays.size > 0) {
          debugLog(`‰ºëÊ•≠Êó•: ${Array.from(holidays).join(', ')}`);
        }
      } catch (error) {
        debugLog(`‚ö†Ô∏è ‰ºëÊ•≠Êó•„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${error.message}`, 'error');
        // ‰ºëÊ•≠Êó•„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Å™„Åè„Å¶„ÇÇÁ∂öË°å
        debugLog('‰ºëÊ•≠Êó•„Éá„Éº„Çø„Å™„Åó„ÅßÁ∂öË°å');
      }
    }

    // ÂïÜÂìÅ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    async function loadProducts() {
      try {
        debugLog('üîç ÂïÜÂìÅ„Éá„Éº„Çø„ÇØ„Ç®„É™ÂÆüË°å‰∏≠...');
        
        // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏çË¶Å„Å™ÂçòÁ¥î„ÇØ„Ç®„É™
        debugLog('üì¶ ÂÖ®ÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæó„ÇíÈñãÂßã');
        const snap = await db.collection('products').get();
        
        debugLog(`üì¶ ÂÖ®ÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæó: ${snap.size}‰ª∂`);
        
        products = [];
        const rawProducts = [];
        
        snap.forEach(doc => {
          const productData = { id: doc.id, ...doc.data() };
          rawProducts.push(productData);
        });
        
        // JavaScript„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Å®„ÇΩ„Éº„Éà
        products = rawProducts
          .filter(p => p.enabled === true)  // enabled„ÅÆ„Åø„Éï„Ç£„É´„Çø
          .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)); // sort_order„Åß„ÇΩ„Éº„Éà
        
        debugLog(`üéØ ÊúâÂäπÂïÜÂìÅ„Éï„Ç£„É´„ÇøÁµêÊûú: ${products.length}‰ª∂`);
        
        products.forEach((p, index) => {
          debugLog(`ÂïÜÂìÅ${index + 1}: ${p.name} - ¬•${p.price} (È†ÜÂ∫è:${p.sort_order})`);
        });
        
        if (products.length === 0) {
          throw new Error('ÊúâÂäπ„Å™ÂïÜÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        }
        
        renderProducts();
        updateSystemStatus('‚úÖ ÂïÜÂìÅ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
        
      } catch (error) {
        debugLog(`‚ùå ÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${error.message}`, 'error');
        updateSystemStatus(`‚ùå ÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${error.message}`, 'error');
        throw error;
      }
    }

    // ÂïÜÂìÅ„É™„Çπ„ÉàÊèèÁîª
    function renderProducts() {
      try {
        debugLog('üé® ÂïÜÂìÅ„É™„Çπ„ÉàÊèèÁîªÈñãÂßã');
        
        els.list.classList.remove('loading');
        els.list.innerHTML = '';
        
        if (products.length === 0) {
          els.list.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">üì¶ ÂïÜÂìÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return;
        }
        
        products.forEach(p => {
          // ‰æ°Ê†º„Åå0ÂÜÜ„ÅÆÂïÜÂìÅ„ÇíÈô§Â§ñ
          if (p.price <= 0) {
            debugLog(`‚ö†Ô∏è ‰æ°Ê†º0ÂÜÜÂïÜÂìÅ„Çí„Çπ„Ç≠„ÉÉ„Éó: ${p.name}`);
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>üçû ${escapeHtml(p.name)}</h3>
            <div>¬•${p.price.toLocaleString()}</div>
            <label>Êï∞Èáè 
              <input type="number" min="0" max="20" value="0" class="qty" data-id="${p.id}">
            </label>
          `;
          els.list.appendChild(card);
          debugLog(`‚úÖ ÂïÜÂìÅ„Ç´„Éº„Éâ‰ΩúÊàê: ${p.name}`);
        });
        
        // Êï∞ÈáèÂ§âÊõ¥„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        els.list.querySelectorAll('.qty').forEach(inp => {
          inp.addEventListener('input', onQuantityChange);
        });
        
        debugLog(`üé® ÂïÜÂìÅ„É™„Çπ„ÉàÊèèÁîªÂÆå‰∫Ü: ${products.length}‰ª∂`);
        
      } catch (error) {
        debugLog(`‚ùå ÂïÜÂìÅ„É™„Çπ„ÉàÊèèÁîª„Ç®„É©„Éº: ${error.message}`, 'error');
        els.list.innerHTML = `<div class="error-info">ÂïÜÂìÅ„É™„Çπ„ÉàË°®Á§∫„Ç®„É©„Éº: ${error.message}</div>`;
      }
    }

    // Êï∞ÈáèÂ§âÊõ¥„Éè„É≥„Éâ„É©
    function onQuantityChange(event) {
      try {
        const inp = event.target;
        const id = inp.dataset.id;
        const q = Math.max(0, Math.min(20, Number(inp.value || 0)));
        
        if (q === 0) {
          delete cart[id];
        } else {
          cart[id] = q;
        }
        
        calcTotal();
        debugLog(`üõí ÂïÜÂìÅÊï∞ÈáèÂ§âÊõ¥: ${id} = ${q}`);
        
      } catch (error) {
        debugLog(`‚ùå Êï∞ÈáèÂ§âÊõ¥„Ç®„É©„Éº: ${error.message}`, 'error');
      }
    }

    // ÂèóÂèñÊó•Â§âÊõ¥„Éè„É≥„Éâ„É©
    function onDateChange() {
      try {
        const d = els.date.value;
        const timeHelp = document.getElementById('timeHelp');
        
        debugLog(`üìÖ ÂèóÂèñÊó•ÈÅ∏Êäû: ${d}`);
        
        // ÊôÇÈñìÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
        els.time.innerHTML = '<option value="">ÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
        
        if (!d) {
          timeHelp.textContent = 'ÂÖà„Å´ÂèóÂèñÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          timeHelp.style.color = '#666';
          return;
        }
        
        if (!isBusinessDay(d, holidays)) {
          timeHelp.textContent = '‚ùå Âñ∂Ê•≠Êó•ÔºàÊ∞¥„ÉªÂúüÔºâ„Åã„Å§Ëá®ÊôÇ‰ºëÊ•≠Êó•‰ª•Â§ñ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          timeHelp.style.color = '#e74c3c';
          showToast('Âñ∂Ê•≠Êó•ÔºàÊ∞¥ÊõúÊó•„ÉªÂúüÊõúÊó•Ôºâ„Åã„Å§Ëá®ÊôÇ‰ºëÊ•≠Êó•‰ª•Â§ñ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', true);
          return;
        }
        
        // Âñ∂Ê•≠Êó•„ÅÆÂ†¥Âêà„ÄÅÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíÁîüÊàê
        const timeSlots = genTimeSlots();
        debugLog(`‚è∞ ÊôÇÈñì„Çπ„É≠„ÉÉ„ÉàÁîüÊàê: ${timeSlots.length}‰ª∂`);
        
        timeSlots.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          els.time.appendChild(opt);
        });
        
        timeHelp.textContent = '‚úÖ ÂèóÂèñÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        timeHelp.style.color = '#27ae60';
        
      } catch (error) {
        debugLog(`‚ùå ÂèóÂèñÊó•Â§âÊõ¥„Ç®„É©„Éº: ${error.message}`, 'error');
        showToast(`Êó•‰ªòÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, true);
      }
    }

    // ÂêàË®àÈáëÈ°çË®àÁÆó
    function calcTotal() {
      try {
        let total = 0;
        let itemCount = 0;
        
        Object.entries(cart).forEach(([pid, qty]) => {
          const p = products.find(x => x.id === pid);
          if (p) {
            total += p.price * qty;
            itemCount += qty;
          }
        });
        
        els.total.textContent = total.toLocaleString();
        debugLog(`üí∞ ÂêàË®àÈáëÈ°çË®àÁÆó: ¬•${total.toLocaleString()} (${itemCount}ÁÇπ)`);
        
      } catch (error) {
        debugLog(`‚ùå ÂêàË®àË®àÁÆó„Ç®„É©„Éº: ${error.message}`, 'error');
        els.total.textContent = '0';
      }
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    function setupEventListeners() {
      debugLog('üîß „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÈñãÂßã');
      
      els.date.addEventListener('change', onDateChange);
      els.pm.addEventListener('change', calcTotal);
      els.btn.addEventListener('click', onSubmit);
      
      debugLog('‚úÖ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
    }

    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    function validate() {
      if (!systemReady) throw new Error('„Ç∑„Çπ„ÉÜ„É†„ÅåÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
      if (!els.date.value || !isBusinessDay(els.date.value, holidays)) throw new Error('ÂèóÂèñÊó•„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ');
      if (!els.time.value) throw new Error('ÂèóÂèñÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');

      // ÈÅéÂéªÊó•ÊôÇÁ¶ÅÊ≠¢ÔºàJSTÔºâ
      const now = new Date(new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }));
      const pick = new Date(`${els.date.value}T${els.time.value}:00+09:00`);
      if (!(pick > now)) throw new Error('ÈÅéÂéª„ÅÆÊó•ÊôÇ„ÅØÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');

      if (!['cash','paypay'].includes(els.pm.value)) throw new Error('ÊîØÊâïÊñπÊ≥ï„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ');
      if (!els.name.value.trim()) throw new Error('Ê∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(els.email.value.trim())) throw new Error('„É°„Éº„É´ÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ');
      if (Object.keys(cart).length === 0) throw new Error('ÂïÜÂìÅÊï∞Èáè„Çí1ÁÇπ‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      
      debugLog('‚úÖ „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÊàêÂäü');
    }

    // ‚òÖ‚òÖ‚òÖ ‰∫àÁ¥ÑÈÄÅ‰ø°ÔºàCORSÂØæÂøúÁâàÔºâ‚òÖ‚òÖ‚òÖ
    async function onSubmit() {
      try {
        els.btn.disabled = true;
        els.btn.classList.add('loading');
        els.btn.textContent = 'üì§ ÈÄÅ‰ø°‰∏≠‚Ä¶';
        
        debugLog('üìù ‰∫àÁ¥ÑÈÄÅ‰ø°ÈñãÂßã');
        validate();

        // „Ç¢„Ç§„ÉÜ„É†Êï¥ÂΩ¢
        const items = Object.entries(cart).map(([pid, qty]) => {
          const p = products.find(x => x.id === pid);
          return { product_id: pid, name: p.name, unit_price: p.price, qty, line_total: p.price * qty };
        });
        const total = items.reduce((a,b)=>a+b.line_total,0);

        const pickupDate = els.date.value;
        const pickupTime = els.time.value;
        const pickupTs   = firebase.firestore.Timestamp.fromDate(new Date(`${pickupDate}T${pickupTime}:00+09:00`));

        debugLog(`üìã ‰∫àÁ¥Ñ„Éá„Éº„Çø‰ΩúÊàê: ${pickupDate} ${pickupTime}, ÂêàË®à¬•${total.toLocaleString()}`);

        // Firestore„Å´‰∫àÁ¥Ñ‰øùÂ≠ò
        const payload = {
          items,
          subtotal: total, 
          total,
          payment_method: els.pm.value,
          pickup_date: pickupDate,
          pickup_time: pickupTime,
          pickup_ts: pickupTs,
          status: 'reserved',
          customer: { 
            name: els.name.value.trim(), 
            email: els.email.value.trim(),
            phone: els.phone.value.trim() || null
          },
          notes: els.notes.value.trim() || null,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        debugLog('üíæ Firestore‰øùÂ≠òÈñãÂßã');
        const ref = await db.collection('reservations').add(payload);
        const reserve_no = `R-${pickupDate.replace(/-/g,'')}-${ref.id.slice(0,5)}`;
        await ref.update({ reserve_no });
        debugLog(`‚úÖ ‰∫àÁ¥Ñ‰øùÂ≠òÂÆå‰∫Ü: ${reserve_no}`);

        // ‚òÖ‰øÆÊ≠£: „É°„Éº„É´ÈÄÅ‰ø°„ÇíÈùûÂêåÊúü„ÅßÂÆüË°åÔºàÂ§±Êïó„Åó„Å¶„ÇÇ‰∫àÁ¥ÑÊàêÂäüÔºâ
        let mailStatus = { success: false, message: 'Á¢∫Ë™ç‰∏≠...' };
        let remindStatus = { success: false, message: 'Á¢∫Ë™ç‰∏≠...' };

        // „É°„Éº„É´ÈÄÅ‰ø°„Çí‰∏¶Ë°åÂÆüË°åÔºà„Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºâ
        const mailPromise = sendToGAS('mail', {
          reserve_no,
          customer: payload.customer,
          pickup: { date: pickupDate, time: pickupTime },
          items: items.map(i=>({name:i.name, qty:i.qty, unit_price:i.unit_price})),
          total, 
          payment_method: payload.payment_method
        }).then(result => {
          debugLog(`üìß „É°„Éº„É´ÈÄÅ‰ø°ÁµêÊûú: ${JSON.stringify(result)}`);
          mailStatus = { 
            success: result.ok, 
            message: result.ok ? 'ÈÄÅ‰ø°ÂÆå‰∫Ü' : `ÈÄÅ‰ø°Â§±Êïó: ${result.error || 'Unknown error'}`,
            method: result.method || 'unknown'
          };
        }).catch(error => {
          debugLog(`üìß „É°„Éº„É´ÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
          mailStatus = { success: false, message: `ÈÄÅ‰ø°Â§±Êïó: ${error.message}` };
        });

        // „É™„Éû„Ç§„É≥„ÉâË®≠ÂÆö„Çí‰∏¶Ë°åÂÆüË°åÔºà„Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºâ
        const remindPromise = sendToGAS('remind', {
          reserve_no,
          customer: payload.customer,
          pickup: { date: pickupDate, time: pickupTime }
        }).then(result => {
          debugLog(`üîî „É™„Éû„Ç§„É≥„ÉâÁµêÊûú: ${JSON.stringify(result)}`);
          remindStatus = { 
            success: result.ok, 
            message: result.ok ? 'Ë®≠ÂÆöÂÆå‰∫Ü' : `Ë®≠ÂÆöÂ§±Êïó: ${result.error || 'Unknown error'}`,
            method: result.method || 'unknown'
          };
        }).catch(error => {
          debugLog(`üîî „É™„Éû„Ç§„É≥„ÉâË®≠ÂÆö„Ç®„É©„Éº: ${error.message}`, 'error');
          remindStatus = { success: false, message: `Ë®≠ÂÆöÂ§±Êïó: ${error.message}` };
        });

        // „É°„Éº„É´„Éª„É™„Éû„Ç§„É≥„ÉâÂá¶ÁêÜ„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß10ÁßíÔºâ
        await Promise.allSettled([
          Promise.race([mailPromise, new Promise(resolve => setTimeout(resolve, 8000))]),
          Promise.race([remindPromise, new Promise(resolve => setTimeout(resolve, 8000))])
        ]);

        debugLog('üéâ ‰∫àÁ¥ÑÂá¶ÁêÜÂÆå‰∫Ü');
        
        // ‰∫àÁ¥ÑÊàêÂäüÁîªÈù¢„Å∏ÈÅ∑ÁßªÔºà„É°„Éº„É´ÈÄÅ‰ø°ÁµêÊûú„ÇíÂê´„ÇÄÔºâ
        showSuccessScreenWithData({
          reserve_no,
          name: payload.customer.name,
          date: pickupDate,
          time: pickupTime,
          payment: payload.payment_method === 'cash' ? 'ÁèæÈáë' : 'PayPay',
          total: total.toLocaleString(),
          mailStatus,
          remindStatus
        });
        
        // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
        resetForm();
        
      } catch (e) {
        debugLog(`‚ùå ‰∫àÁ¥ÑÈÄÅ‰ø°„Ç®„É©„Éº: ${e.message}`, 'error');
        debugLog(`„Ç®„É©„ÉºË©≥Á¥∞: ${e.stack}`, 'error');
        showToast(`‰∫àÁ¥Ñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`, true);
      } finally {
        els.btn.disabled = false;
        els.btn.classList.remove('loading');
        els.btn.textContent = 'üìù ‰∫àÁ¥Ñ„Åô„Çã';
      }
    }

    // ÊàêÂäüÁîªÈù¢Ë°®Á§∫Ôºà„É°„Éº„É´Áä∂ÊÖã‰ªò„ÅçÔºâ
    function showSuccessScreenWithData(data) {
      document.getElementById('successReserveNo').textContent = data.reserve_no;
      document.getElementById('successName').textContent = data.name;
      document.getElementById('successDateTime').textContent = `${data.date} ${data.time}`;
      document.getElementById('successPayment').textContent = data.payment;
      document.getElementById('successTotal').textContent = `¬•${data.total}`;
      
      // „É°„Éº„É´Áä∂ÊÖãË°®Á§∫
      const mailStatusEl = document.getElementById('mailStatus');
      if (data.mailStatus) {
        if (data.mailStatus.success) {
          mailStatusEl.innerHTML = '<p style="color: #27ae60;">‚úÖ „ÅîÂÖ•Âäõ„ÅÑ„Åü„Å†„ÅÑ„Åü„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å´Á¢∫Ë™ç„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åó„Åæ„Åó„Åü„ÄÇ</p>';
        } else {
          mailStatusEl.innerHTML = `
            <div class="warning-notice">
              ‚ö†Ô∏è Á¢∫Ë™ç„É°„Éº„É´„ÅÆÈÄÅ‰ø°„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ<br>
              ${escapeHtml(data.mailStatus.message)}<br>
              <small>‰∫àÁ¥Ñ„ÅØÊ≠£Â∏∏„Å´ÂÆå‰∫Ü„Åó„Å¶„Åä„Çä„Åæ„Åô„ÅÆ„Åß„ÄÅ„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ</small>
            </div>
          `;
        }
      } else {
        mailStatusEl.innerHTML = '<p style="color: #666;">üìß Á¢∫Ë™ç„É°„Éº„É´ÈÄÅ‰ø°Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç‰∏≠...</p>';
      }
      
      showSuccessScreen();
    }

    // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
    function resetForm() {
      cart = {};
      document.querySelectorAll('.qty').forEach(i=>i.value=0);
      calcTotal();
      els.date.value = '';
      els.time.innerHTML = '<option value="">ÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
      els.name.value = '';
      els.email.value = '';
      els.phone.value = '';
      els.notes.value = '';
      
      // „Éò„É´„Éó„ÉÜ„Ç≠„Çπ„Éà„ÇÇ„É™„Çª„ÉÉ„Éà
      document.getElementById('dateHelp').textContent = 'Âñ∂Ê•≠Êó•ÔºàÊ∞¥ÊõúÊó•„ÉªÂúüÊõúÊó•Ôºâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      document.getElementById('dateHelp').style.color = '#666';
      document.getElementById('timeHelp').textContent = 'ÂÖà„Å´ÂèóÂèñÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      document.getElementById('timeHelp').style.color = '#666';
    }

    // „Éà„Éº„Çπ„ÉàË°®Á§∫
    function showToast(msg, isErr=false, isWarning=false) {
      els.toast.textContent = msg;
      els.toast.classList.remove('hidden');
      els.toast.className = 'toast' + (isErr ? ' error' : isWarning ? ' warning' : '');
      setTimeout(()=>{ els.toast.classList.add('hidden'); }, 8000);
      
      debugLog(`üì¢ „Éà„Éº„Çπ„ÉàË°®Á§∫: ${msg}`, isErr ? 'error' : 'info');
    }

    // ÂàùÊúüÂåñÂÆüË°å
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('üìÑ DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
      init().catch(e => {
        debugLog(`üí• ÂàùÊúüÂåñÂ§±Êïó: ${e.message}`, 'error');
        showToast(`„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`, true);
      });
    });
  </script>
</body>
</html>