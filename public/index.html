<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>カンパーニュ予約（簡素版）</title>
    <style>
      /* 既存のスタイルを維持（省略） */
      body {
        font-family: system-ui, sans-serif;
        background: #f4f1ed;
        margin: 0;
        line-height: 1.6;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      label {
        display: block;
        margin-bottom: 1rem;
      }
      input, select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        box-sizing: border-box;
      }
      button {
        background: #ff9b21;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        cursor: pointer;
      }
      button:hover {
        background: #e0881c;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 4px;
        display: none;
        z-index: 1000;
      }
      .toast.success { background: #38a169; }
      .toast.error { background: #e53e3e; }
      .back-to-top {
        position: fixed;
        bottom: 20px;
        left: 20px;
        display: none;
        background: #ff9b21;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        cursor: pointer;
      }
    </style>
    </head>
<body>
  <main class="container">
    <div id="reservationForm">
      <h1>🍞 カンパーニュ受取予約フォーム</h1>

      <!-- Web3.0Forms統合フォーム -->
      <form id="reservationForm" data-web3forms-key="15433c4c-2f75-48a4-ad16-f191f511b77e">
        <section>
          <h2>📅 受取日時の選択</h2>
          <label>受取日（水・土のみ）<span style="color: #e53e3e;">*</span>
            <input type="date" name="pickup_date" id="pickupDate" required />
          </label>
          
          <label>受取時間（11:00–17:00）<span style="color: #e53e3e;">*</span>
            <select name="pickup_time" id="pickupTime" required>
              <option value="">時間を選択してください</option>
            </select>
          </label>
          
          <label>支払方法<span style="color: #e53e3e;">*</span>
            <select name="payment_method" id="paymentMethod" required>
              <option value="cash">💰 現金</option>
              <option value="paypay">📱 PayPay</option>
            </select>
          </label>
        </section>

        <section>
          <h2>🛒 商品を選択</h2>
          <div id="productList" class="grid"></div>
          <div class="total">合計: ¥<span id="total">0</span></div>
          <input type="hidden" name="order_items" id="orderItems" />
          <input type="hidden" name="total_amount" id="totalAmount" />
        </section>

        <section>
          <h2>👤 お客様情報</h2>
          <label>お名前<span style="color: #e53e3e;">*</span>
            <input name="customer_name" id="custName" placeholder="山田太郎" required />
          </label>
          
          <label>メールアドレス<span style="color: #e53e3e;">*</span>
            <input name="email" id="custEmail" type="email" placeholder="taro@example.com" required />
          </label>
          
          <label>電話番号（任意）
            <input name="phone" id="custPhone" type="tel" placeholder="090-1234-5678" />
          </label>
        </section>

        <button type="submit">📝 予約を確定する</button>
        <input type="hidden" name="_next" value="https://yoursite.com/success.html">
      </form>
    </div>
    </main>
    <div id="toast" class="toast"></div>
    <button id="backToTop" class="back-to-top" aria-label="ページ上部へ戻る">▲</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyC7e6YZSeh1RYBdWEfob6xT7XnxBIZu2Uw",
      authDomain: "hyggelyreservationsystem.firebaseapp.com",
      projectId: "hyggelyreservationsystem",
      storageBucket: "hyggelyreservationsystem.firebasestorage.app",
      messagingSenderId: "549459143900",
      appId: "1:549459143900:web:7d9f2bb6ddc22573869819"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // グローバル変数
    let products = [];
    let cart = {};
    let holidays = new Set();

    // システム初期化
    async function init() {
      try {
        console.log('システム初期化開始');
        
        await Promise.all([
          loadProducts(),
          loadHolidays()
        ]);
        
        setupEventListeners();
        showToast('システムの準備が完了しました。ご予約をお進めください。', 'success');
        
        console.log('システム初期化完了');
      } catch (error) {
        console.error('初期化エラー:', error);
        showToast(`システム初期化に失敗しました: ${error.message}`, 'error');
      }
    }

    // イベントリスナー設定
    function setupEventListeners() {
      console.log('イベントリスナー設定開始');
      
      // 受取日変更イベント
      const pickupDate = document.getElementById('pickupDate');
      if (pickupDate) {
        pickupDate.addEventListener('change', handleDateChange);
        console.log('受取日イベントリスナー設定完了');
      }

      // 支払方法変更イベント
      const paymentMethod = document.getElementById('paymentMethod');
      if (paymentMethod) {
        paymentMethod.addEventListener('change', calculateTotal);
        console.log('支払方法イベントリスナー設定完了');
      }
      
      console.log('イベントリスナー設定完了');
    }

    // 商品読み込み
    async function loadProducts() {
      try {
        console.log('商品データ読み込み開始');
        
        const snapshot = await db.collection('products')
          .where('enabled', '==', true)
          .orderBy('sort_order')
          .get();
        
        products = [];
        snapshot.forEach(doc => {
          products.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`商品データ読み込み完了: ${products.length}件`);
        renderProducts();
        
      } catch (error) {
        console.error('商品読み込みエラー:', error);
        throw error;
      }
    }

    // 休業日読み込み
    async function loadHolidays() {
      try {
        console.log('休業日データ読み込み開始');
        
        const snapshot = await db.collection('holidays').get();
        holidays.clear();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.date) holidays.add(data.date);
        });
        
        console.log(`休業日データ読み込み完了: ${holidays.size}件`);
        
      } catch (error) {
        console.warn('休業日読み込みエラー（継続）:', error);
        // 休業日取得失敗は致命的ではないので続行
      }
    }

    // 商品表示
    function renderProducts() {
      const productList = document.getElementById('productList');
      if (!productList) {
        console.error('商品リスト要素が見つかりません');
        return;
      }
      
      productList.innerHTML = '';
      
      if (products.length === 0) {
        productList.innerHTML = '<p>商品データがありません</p>';
        return;
      }
      
      products.forEach(product => {
        if (product.price <= 0) {
          console.log(`価格0円商品をスキップ: ${product.name}`);
          return;
        }
        
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>🍞 ${escapeHtml(product.name)}</h3>
          <div>¥${product.price.toLocaleString()}</div>
          <label>数量 
            <input type="number" min="0" max="20" value="0" class="qty" data-id="${product.id}" onchange="updateQuantity(this)">
          </label>
        `;
        productList.appendChild(card);
      });
      
      console.log(`商品カード表示完了: ${products.length}件`);
    }

    // 受取日変更処理
    function handleDateChange() {
      const selectedDate = document.getElementById('pickupDate').value;
      const timeSelect = document.getElementById('pickupTime');
      const timeHelp = document.getElementById('timeHelp');
      
      console.log('受取日変更:', selectedDate);
      
      if (!timeSelect || !timeHelp) {
        console.error('時間選択要素が見つかりません');
        return;
      }
      
      timeSelect.innerHTML = '<option value="">時間を選択してください</option>';
      
      if (!selectedDate) {
        timeHelp.textContent = '先に受取日を選択してください';
        timeHelp.style.color = '#718096';
        return;
      }
      
      if (!isBusinessDay(selectedDate)) {
        timeHelp.textContent = '❌ 営業日（水・土）かつ臨時休業日以外を選択してください';
        timeHelp.style.color = '#e53e3e';
        showToast('営業日（水曜日・土曜日）かつ臨時休業日以外を選択してください', 'error');
        return;
      }
      
      // 時間スロット生成（11:00-17:00、30分刻み）
      const slots = generateTimeSlots();
      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.textContent = slot;
        timeSelect.appendChild(option);
      });
      
      timeHelp.textContent = '✅ 受取時間を選択してください';
      timeHelp.style.color = '#38a169';
      
      console.log(`時間スロット生成完了: ${slots.length}個`);
    }

    // 営業日判定
    function isBusinessDay(dateStr) {
      try {
        const date = new Date(dateStr + 'T00:00:00+09:00');
        const dayOfWeek = date.getDay();
        
        if (holidays.has(dateStr)) {
          console.log(`${dateStr} は臨時休業日`);
          return false;
        }
        
        const isBusiness = dayOfWeek === 3 || dayOfWeek === 6; // 水曜日または土曜日
        console.log(`${dateStr} 曜日:${dayOfWeek} 営業日:${isBusiness}`);
        return isBusiness;
        
      } catch (error) {
        console.error('営業日判定エラー:', error);
        return false;
      }
    }

    // 時間スロット生成
    function generateTimeSlots(start = "11:00", end = "17:00", interval = 30) {
      try {
        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);
        const startMinutes = startH * 60 + startM;
        const endMinutes = endH * 60 + endM;
        
        const slots = [];
        for (let minutes = startMinutes; minutes <= endMinutes; minutes += interval) {
          const hours = String(Math.floor(minutes / 60)).padStart(2, '0');
          const mins = String(minutes % 60).padStart(2, '0');
          slots.push(`${hours}:${mins}`);
        }
        
        return slots;
      } catch (error) {
        console.error('時間スロット生成エラー:', error);
        return [];
      }
    }

    // 数量変更
    function updateQuantity(input) {
      try {
        const productId = input.dataset.id;
        const quantity = Math.max(0, Math.min(20, Number(input.value || 0)));
        
        input.value = quantity;
        
        if (quantity === 0) {
          delete cart[productId];
        } else {
          cart[productId] = quantity;
        }
        
        calculateTotal();
        console.log(`商品数量変更: ${productId} = ${quantity}`);
        
      } catch (error) {
        console.error('数量変更エラー:', error);
      }
    }

    // 合計計算
    function calculateTotal() {
      try {
        let totalAmount = 0;
        let itemCount = 0;
        
        Object.entries(cart).forEach(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          if (product) {
            totalAmount += product.price * quantity;
            itemCount += quantity;
          }
        });
        
        const totalEl = document.getElementById('total');
        if (totalEl) {
          totalEl.textContent = totalAmount.toLocaleString();
        }
        
        console.log(`合計計算: ¥${totalAmount.toLocaleString()} (${itemCount}点)`);
        return totalAmount;
        
      } catch (error) {
        console.error('合計計算エラー:', error);
        return 0;
      }
    }

    // フォーム送信処理
    async function handleSubmit() {
      try {
        console.log('予約送信処理開始');
        
        // ボタン無効化
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = '処理中...';
        }
        
        // バリデーション
        validateForm();
        
        // 予約データ作成
        const orderItems = Object.entries(cart).map(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          return {
            product_id: productId,
            name: product.name,
            unit_price: product.price,
            qty: quantity,
            line_total: product.price * quantity
          };
        });
        
        const totalAmount = calculateTotal();
        
        const reservationData = {
          items: orderItems,
          subtotal: totalAmount,
          total: totalAmount,
          payment_method: document.getElementById('paymentMethod').value,
          pickup_date: document.getElementById('pickupDate').value,
          pickup_time: document.getElementById('pickupTime').value,
          pickup_ts: firebase.firestore.Timestamp.fromDate(
            new Date(`${document.getElementById('pickupDate').value}T${document.getElementById('pickupTime').value}:00+09:00`)
          ),
          status: 'reserved',
          customer: {
            name: document.getElementById('custName').value.trim(),
            email: document.getElementById('custEmail').value.trim(),
            phone: document.getElementById('custPhone').value.trim() || null
          },
          notes: document.getElementById('notes').value.trim() || null,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        console.log('予約データ:', reservationData);
        
        // Firestore保存
        const docRef = await db.collection('reservations').add(reservationData);
        const reserveNo = `R-${reservationData.pickup_date.replace(/-/g,'')}-${docRef.id.slice(0,5)}`;
        await docRef.update({ reserve_no: reserveNo });
        
        console.log(`予約保存完了: ${reserveNo}`);
        
        // 成功画面表示
        showSuccessScreen({
          reserveNo: reserveNo,
          customerName: reservationData.customer.name,
          pickupDate: reservationData.pickup_date,
          pickupTime: reservationData.pickup_time,
          paymentMethod: reservationData.payment_method === 'cash' ? '現金' : 'PayPay',
          totalAmount: totalAmount.toLocaleString()
        });
        
        // フォームリセット
        resetForm();
        
      } catch (error) {
        console.error('予約エラー:', error);
        showToast(`予約に失敗しました: ${error.message}`, 'error');
      } finally {
        // ボタン復旧
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = '📝 予約を確定する';
        }
      }
    }

    // バリデーション
    function validateForm() {
      const pickupDate = document.getElementById('pickupDate').value;
      const pickupTime = document.getElementById('pickupTime').value;
      const custName = document.getElementById('custName').value.trim();
      const custEmail = document.getElementById('custEmail').value.trim();
      
      if (!pickupDate || !isBusinessDay(pickupDate)) {
        throw new Error('有効な受取日を選択してください');
      }
      
      if (!pickupTime) {
        throw new Error('受取時間を選択してください');
      }
      
      if (!custName) {
        throw new Error('お名前を入力してください');
      }
      
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(custEmail)) {
        throw new Error('正しいメールアドレスを入力してください');
      }
      
      if (Object.keys(cart).length === 0) {
        throw new Error('商品を1点以上選択してください');
      }
      
      const now = new Date();
      const pickupDateTime = new Date(`${pickupDate}T${pickupTime}:00+09:00`);
      if (pickupDateTime <= now) {
        throw new Error('過去の日時は選択できません');
      }
      
      console.log('バリデーション成功');
    }

    // 成功画面表示
    function showSuccessScreen(data) {
      const elements = {
        reserveNo: document.getElementById('successReserveNo'),
        name: document.getElementById('successName'),
        dateTime: document.getElementById('successDateTime'),
        payment: document.getElementById('successPayment'),
        total: document.getElementById('successTotal')
      };
      
      if (elements.reserveNo) elements.reserveNo.textContent = data.reserveNo;
      if (elements.name) elements.name.textContent = data.customerName;
      if (elements.dateTime) elements.dateTime.textContent = `${data.pickupDate} ${data.pickupTime}`;
      if (elements.payment) elements.payment.textContent = data.paymentMethod;
      if (elements.total) elements.total.textContent = `¥${data.totalAmount}`;
      
      const formEl = document.getElementById('reservationForm');
      const successEl = document.getElementById('successScreen');
      
      if (formEl) formEl.classList.add('hidden');
      if (successEl) successEl.style.display = 'block';
      
      window.scrollTo(0, 0);
      console.log('成功画面表示完了');
    }
    
    // フォームに戻る
    function backToForm() {
      const formEl = document.getElementById('reservationForm');
      const successEl = document.getElementById('successScreen');
      
      if (successEl) successEl.style.display = 'none';
      if (formEl) formEl.classList.remove('hidden');
      
      window.scrollTo(0, 0);
      console.log('フォーム画面に復帰');
    }

    // フォームリセット
    function resetForm() {
      try {
        cart = {};
        
        // 数量リセット
        document.querySelectorAll('.qty').forEach(input => {
          input.value = 0;
        });
        calculateTotal();
        
        // フィールドクリア
        const fields = ['pickupDate', 'custName', 'custEmail', 'custPhone', 'notes'];
        fields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) field.value = '';
        });
        
        // 時間選択リセット
        const timeSelect = document.getElementById('pickupTime');
        if (timeSelect) {
          timeSelect.innerHTML = '<option value="">時間を選択してください</option>';
        }
        
        // 支払方法リセット
        const paymentMethod = document.getElementById('paymentMethod');
        if (paymentMethod) {
          paymentMethod.value = 'cash';
        }
        
        console.log('フォームリセット完了');
        
      } catch (error) {
        console.error('フォームリセットエラー:', error);
      }
    }

    // トースト表示
    function showToast(message, type = 'success', duration = 5000) {
      const toast = document.getElementById('toast');
      if (!toast) {
        console.warn('トースト要素が見つかりません');
        return;
      }
      
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
      
      console.log(`トースト表示: ${message} (${type})`);
    }

    // ページ上部へ戻るボタン
    function setupBackToTop() {
      const btn = document.getElementById('backToTop');
      if (!btn) return;
      window.addEventListener('scroll', () => {
        btn.style.display = window.scrollY > 200 ? 'block' : 'none';
      });
      btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 初期化実行
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM読み込み完了、初期化開始');
      init().catch(error => {
        console.error('初期化失敗:', error);
        showToast(`システム初期化に失敗しました: ${error.message}`, 'error');
      });
      setupBackToTop();
    });
</script>
</body>
</html>