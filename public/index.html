<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥äºˆç´„</title>
  <style>
    /* =========================== */
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå…ƒã®style.css + æ‹¡å¼µï¼‰ */
    /* =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fafafa; 
      line-height: 1.6;
      color: #333;
    }

    .container { 
      max-width: 900px; 
      margin: 24px auto; 
      padding: 16px; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 2px 12px rgba(0,0,0,.06); 
    }

    h1, h2 { 
      margin: 8px 0 16px; 
      color: #2d6cdf;
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 24px;
    }

    h2 {
      font-size: 1.5rem;
      border-bottom: 2px solid #e8f4fd;
      padding-bottom: 8px;
      margin-top: 32px;
    }

    label { 
      display: block; 
      margin: 8px 0;
      font-weight: 500;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 4px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2d6cdf;
      box-shadow: 0 0 0 3px rgba(45, 108, 223, 0.1);
    }

    small {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }

    section {
      margin: 24px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
      gap: 12px; 
      margin-top: 16px;
    }

    .card { 
      border: 1px solid #e1e8ed; 
      padding: 16px; 
      border-radius: 10px; 
      background: white;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .card h3 { 
      margin: 0 0 8px; 
      font-size: 16px; 
      color: #2d6cdf;
      font-weight: 600;
    }

    .card > div {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .qty { 
      width: 70px; 
      text-align: center;
      margin-top: 4px;
    }

    .total { 
      font-size: 20px; 
      font-weight: bold; 
      margin-top: 16px;
      padding: 16px;
      background: #e8f4fd;
      border-radius: 8px;
      text-align: center;
      color: #2d6cdf;
    }

    button { 
      width: 100%;
      padding: 16px 24px; 
      border: none; 
      background: #2d6cdf; 
      color: #fff; 
      border-radius: 8px; 
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 24px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: #1e4ba8;
      transform: translateY(-1px);
    }

    button:disabled { 
      background: #999; 
      cursor: not-allowed;
      transform: none;
    }

    button.loading { 
      opacity: .7; 
      pointer-events: none; 
    }

    .toast { 
      margin-top: 16px; 
      padding: 16px; 
      border-radius: 8px; 
      background: #d4edda; 
      color: #155724;
      border: 1px solid #c3e6cb;
      font-weight: 500;
    }

    .toast.error { 
      background: #f8d7da; 
      color: #721c24;
      border-color: #f5c6cb;
    }

    .toast.warning { 
      background: #fff3cd; 
      color: #856404;
      border-color: #ffeaa7;
    }

    /* =========================== */
    /* ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    /* =========================== */
    .debug-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      font-size: 12px;
      color: #0d47a1;
      max-height: 300px;
      overflow-y: auto;
    }

    .debug-info h3 {
      margin: 0 0 12px;
      color: #1565c0;
      font-size: 14px;
    }

    .debug-info div {
      margin: 4px 0;
      padding: 2px 0;
      border-bottom: 1px solid rgba(33, 150, 243, 0.1);
      font-family: monospace;
    }

    .error-info {
      background: #ffebee;
      border: 1px solid #f44336;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #c62828;
      font-weight: 500;
    }

    .loading {
      background: #fff3e0;
      border: 1px solid #ff9800;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #e65100;
      font-weight: 500;
      text-align: center;
    }

    .success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      color: #2e7d32;
      font-weight: 500;
      text-align: center;
    }

    #productList.loading::after {
      content: "ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...";
      display: block;
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }

    /* =========================== */
    /* äºˆç´„å®Œäº†ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
    /* =========================== */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-radius: 16px;
      border: 2px solid #4caf50;
      margin: 20px 0;
    }

    .success-screen h2 {
      color: #2e7d32;
      font-size: 2rem;
      margin-bottom: 20px;
      border: none;
    }

    .success-icon {
      font-size: 4rem;
      color: #4caf50;
      margin-bottom: 20px;
      display: block;
    }

    .reservation-details {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid #c8e6c9;
    }

    .reservation-details h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e8f5e9;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: #2e7d32;
    }

    .detail-value {
      color: #1b5e20;
    }

    .back-button {
      background: #4caf50;
      margin-top: 20px;
    }

    .back-button:hover:not(:disabled) {
      background: #388e3c;
    }

    .warning-notice {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      color: #856404;
      font-size: 14px;
    }

    /* =========================== */
    /* ãƒœã‚¿ãƒ³è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    /* =========================== */
    .btn-secondary {
      background: #6c757d;
      color: white;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin: 10px 0;
      display: inline-block;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }

    /* =========================== */
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    /* =========================== */
    @media (max-width: 768px) {
      .container {
        margin: 12px;
        padding: 12px;
      }

      h1 {
        font-size: 1.8rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      section {
        padding: 16px;
      }

      button {
        padding: 14px 20px;
      }

      .success-screen h2 {
        font-size: 1.6rem;
      }

      .success-icon {
        font-size: 3rem;
      }

      .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 8px;
        padding: 8px;
      }

      h1 {
        font-size: 1.6rem;
      }

      section {
        padding: 12px;
      }

      input, select {
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* =========================== */
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    /* =========================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes checkmark {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .container {
      animation: fadeIn 0.5s ease-out;
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    .success-screen {
      animation: fadeIn 0.6s ease-out;
    }

    .success-icon {
      animation: checkmark 0.8s ease-out;
    }

    /* =========================== */
    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
    /* =========================== */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }

    .hidden { display: none; }

    /* =========================== */
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    /* =========================== */
    .debug-info::-webkit-scrollbar {
      width: 6px;
    }

    .debug-info::-webkit-scrollbar-track {
      background: rgba(33, 150, 243, 0.1);
      border-radius: 3px;
    }

    .debug-info::-webkit-scrollbar-thumb {
      background: rgba(33, 150, 243, 0.3);
      border-radius: 3px;
    }

    .debug-info::-webkit-scrollbar-thumb:hover {
      background: rgba(33, 150, 243, 0.5);
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ -->
    <div id="reservationForm">
      <h1>ğŸ ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å—å–äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h1>

      <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="debugInfo" class="debug-info hidden">
        <h3>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div id="debugContent"></div>
      </div>

      <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
      <div id="systemStatus" class="loading">
        ğŸ“¡ ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šã‚’ç¢ºèªä¸­...
      </div>

      <section>
        <h2>ğŸ“… å—å–æ—¥æ™‚ã®é¸æŠ</h2>
        <label>å—å–æ—¥ï¼ˆæ°´ãƒ»åœŸã®ã¿ï¼‰
          <input type="date" id="pickupDate" />
          <small id="dateHelp">å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </label>
        
        <label>å—å–æ™‚é–“ï¼ˆ11:00â€“17:00ï¼‰
          <select id="pickupTime">
            <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
          <small id="timeHelp">å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </label>
        
        <label>æ”¯æ‰•æ–¹æ³•
          <select id="paymentMethod">
            <option value="cash">ğŸ’° ç¾é‡‘</option>
            <option value="paypay">ğŸ“± PayPay</option>
          </select>
        </label>
      </section>

      <section>
        <h2>ğŸ›’ å•†å“ã‚’é¸æŠ</h2>
        <div id="productStatus" class="loading">å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="productList" class="grid loading"></div>
        <div class="total">åˆè¨ˆ: Â¥<span id="total">0</span></div>
      </section>

      <section>
        <h2>ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±</h2>
        <label>æ°å <span style="color: #e74c3c;">*</span>
          <input id="custName" placeholder="å±±ç”°å¤ªéƒ" required />
        </label>
        
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color: #e74c3c;">*</span>
          <input id="custEmail" type="email" placeholder="taro@example.com" required />
        </label>
        
        <label>é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰
          <input id="custPhone" type="tel" placeholder="090-1234-5678" />
        </label>
        
        <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰
          <input id="notes" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚„ã”è¦æœ›ãªã©ã”ã–ã„ã¾ã—ãŸã‚‰ã”è¨˜å…¥ãã ã•ã„" />
        </label>
      </section>

      <button id="submitBtn" disabled>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</button>
      
      <div id="toast" class="toast hidden"></div>

      <!-- è©³ç´°ãƒ­ã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ -->
      <button type="button" onclick="toggleDebug()" class="btn-secondary">
        ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      </button>
    </div>

    <!-- äºˆç´„å®Œäº†ç”»é¢ -->
    <div id="successScreen" class="hidden">
      <div class="success-screen">
        <span class="success-icon">âœ…</span>
        <h2>äºˆç´„å®Œäº†ã„ãŸã—ã¾ã—ãŸï¼</h2>
        <p>ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã§æ‰¿ã‚Šã¾ã—ãŸã€‚</p>
        
        <div class="reservation-details">
          <h3>ğŸ“‹ äºˆç´„è©³ç´°</h3>
          <div class="detail-row">
            <span class="detail-label">äºˆç´„ç•ªå·:</span>
            <span class="detail-value" id="successReserveNo">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ãŠåå‰:</span>
            <span class="detail-value" id="successName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">å—å–æ—¥æ™‚:</span>
            <span class="detail-value" id="successDateTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ãŠæ”¯æ‰•ã„:</span>
            <span class="detail-value" id="successPayment">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">åˆè¨ˆé‡‘é¡:</span>
            <span class="detail-value" id="successTotal">-</span>
          </div>
        </div>

        <div class="reservation-details">
          <h3>ğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«</h3>
          <div id="mailStatus"></div>
        </div>

        <div class="reservation-details">
          <h3>ğŸ“ åº—èˆ—æƒ…å ±</h3>
          <p><strong>å—å–å ´æ‰€:</strong> ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥</p>
          <p><strong>å–¶æ¥­æ—¥:</strong> æ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥</p>
          <p><strong>å–¶æ¥­æ™‚é–“:</strong> 11:00ï½17:00</p>
          <p style="margin-top: 10px; color: #666; font-size: 14px;">
            â€» å½“æ—¥ãŠæ°—ã‚’ã¤ã‘ã¦ãŠè¶Šã—ãã ã•ã„<br>
            â€» ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã®é€£çµ¡å…ˆã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„
          </p>
        </div>

        <button class="back-button" onclick="backToForm()">ğŸ”™ æ–°ã—ã„äºˆç´„ã‚’ã™ã‚‹</button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // â˜…Firebaseè¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyC7e6YZSeh1RYBdWEfob6xT7XnxBIZu2Uw",
      authDomain: "hyggelyreservationsystem.firebaseapp.com",
      projectId: "hyggelyreservationsystem",
      storageBucket: "hyggelyreservationsystem.firebasestorage.app",
      messagingSenderId: "549459143900",
      appId: "1:549459143900:web:7d9f2bb6ddc22573869819"
    };

    // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
    let debugMode = false;
    let debugLogs = [];
    
    function debugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
      debugLogs.push(logEntry);
      console.log(logEntry);
      
      if (debugMode) {
        updateDebugDisplay();
      }
    }
    
    function updateDebugDisplay() {
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        debugContent.innerHTML = debugLogs.slice(-20).map(log => `<div>${escapeHtml(log)}</div>`).join('');
      }
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.classList.toggle('hidden', !debugMode);
        if (debugMode) updateDebugDisplay();
      }
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showSuccessScreen() {
      document.getElementById('reservationForm').classList.add('hidden');
      document.getElementById('successScreen').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    function backToForm() {
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('reservationForm').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // FirebaseåˆæœŸåŒ–
    try {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      debugLog('FirebaseåˆæœŸåŒ–æˆåŠŸ');
    } catch (error) {
      debugLog(`FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      updateSystemStatus('âŒ FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }

    // â˜…GASè¨­å®š
    window.GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzqQsqyFmV6HC0l174c73TM4bwhni0hleo2M7-rSoltVoxAjFODwFJQsoJlMaNe_hUv/exec";
    window.GAS_API_KEY  = "91d012136acf47f0b65ca8f84aceced56af240e21d3f42878f6e535dfe03a625";

    // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
    function updateSystemStatus(message, type = 'loading') {
      const statusEl = document.getElementById('systemStatus');
      const productStatusEl = document.getElementById('productStatus');
      
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = type;
      }
      
      if (productStatusEl && type !== 'loading') {
        productStatusEl.textContent = type === 'success' ? 'âœ… å•†å“ä¸€è¦§' : message;
        productStatusEl.className = type;
      }
    }

    // æ™‚é–“é–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function isBusinessDay(dateStr, holidaysSet) {
      try {
        const d = new Date(dateStr + 'T00:00:00+09:00');
        const wd = d.getDay(); // 0=æ—¥..6=åœŸ
        if (holidaysSet && holidaysSet.has(dateStr)) {
          debugLog(`${dateStr}ã¯è‡¨æ™‚ä¼‘æ¥­æ—¥ã§ã™`);
          return false;
        }
        const isBusiness = wd === 3 || wd === 6; // æ°´æ›œ(3)ãƒ»åœŸæ›œ(6)
        debugLog(`${dateStr} æ›œæ—¥:${wd} å–¶æ¥­æ—¥:${isBusiness}`);
        return isBusiness;
      } catch (error) {
        debugLog(`å–¶æ¥­æ—¥åˆ¤å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return false;
      }
    }

    function genTimeSlots(open = "11:00", close = "17:00", stepMin = 30) {
      try {
        const [oh, om] = open.split(':').map(Number);
        const [ch, cm] = close.split(':').map(Number);
        let start = oh * 60 + om, end = ch * 60 + cm;
        const slots = [];
        for (let m = start; m <= end; m += stepMin) {
          const hh = String(Math.floor(m / 60)).padStart(2, '0');
          const mm = String(m % 60).padStart(2, '0');
          slots.push(`${hh}:${mm}`);
        }
        debugLog(`æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ: ${slots.length}ä»¶ (${slots[0]} - ${slots[slots.length-1]})`);
        return slots;
      } catch (error) {
        debugLog(`æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return [];
      }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // â˜…â˜…â˜… CORSå¯¾å¿œã®GASé€šä¿¡é–¢æ•° â˜…â˜…â˜…
    async function sendToGAS(path, data, retries = 2) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          debugLog(`GASé€šä¿¡è©¦è¡Œ ${attempt}/${retries}: ${path}`);
          
          // æ–¹æ³•1: FormDataä½¿ç”¨ï¼ˆpreflightã‚’é¿ã‘ã‚‹ï¼‰
          const formData = new FormData();
          formData.append('key', GAS_API_KEY);
          formData.append('path', path);
          formData.append('data', JSON.stringify(data));
          
          const response = await fetch(GAS_ENDPOINT, {
            method: 'POST',
            body: formData,
            mode: 'cors',
            credentials: 'omit'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          debugLog(`GASé€šä¿¡æˆåŠŸ: ${path} - ${JSON.stringify(result)}`);
          return result;
          
        } catch (error) {
          debugLog(`GASé€šä¿¡å¤±æ•— ${attempt}/${retries}: ${error.message}`, 'error');
          
          if (attempt === retries) {
            // æœ€å¾Œã®è©¦è¡Œã§ã‚‚å¤±æ•—ã—ãŸå ´åˆ
            debugLog(`GASé€šä¿¡æœ€çµ‚å¤±æ•—: ${path}`, 'error');
            
            // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯åˆ¥ã®æ–¹æ³•ã‚’è©¦è¡Œ
            if (error.message.includes('CORS') || error.message.includes('fetch')) {
              return await sendToGASFallback(path, data);
            }
            
            throw error;
          }
          
          // ãƒªãƒˆãƒ©ã‚¤å‰ã«å°‘ã—å¾…æ©Ÿ
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
    }

    // â˜…â˜…â˜… GASé€šä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆGETæ–¹å¼ï¼‰â˜…â˜…â˜…
    async function sendToGASFallback(path, data) {
      try {
        debugLog(`GASãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šä¿¡: ${path}`);
        
        // GETãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ä¿¡ï¼ˆCORSã‚’å›é¿ï¼‰
        const params = new URLSearchParams({
          key: GAS_API_KEY,
          path: path,
          data: JSON.stringify(data)
        });
        
        const url = `${GAS_ENDPOINT}?${params.toString()}`;
        
        // imgè¦ç´ ã‚’ä½¿ç”¨ã—ãŸéåŒæœŸé€šä¿¡ï¼ˆCORSã‚’å®Œå…¨ã«å›é¿ï¼‰
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            debugLog(`GASãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šä¿¡å®Œäº†: ${path}`);
            resolve({ ok: true, method: 'fallback' });
          };
          img.onerror = () => {
            debugLog(`GASãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${path}`, 'error');
            resolve({ ok: false, method: 'fallback', error: 'image_load_failed' });
          };
          img.src = url;
          
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
          setTimeout(() => {
            debugLog(`GASãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${path}`, 'error');
            resolve({ ok: false, method: 'fallback', error: 'timeout' });
          }, 10000);
        });
        
      } catch (error) {
        debugLog(`GASãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return { ok: false, method: 'fallback', error: error.message };
      }
    }
  </script>

  <!-- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
    const els = {
      date:  document.getElementById('pickupDate'),
      time:  document.getElementById('pickupTime'),
      pm:    document.getElementById('paymentMethod'),
      list:  document.getElementById('productList'),
      total: document.getElementById('total'),
      name:  document.getElementById('custName'),
      email: document.getElementById('custEmail'),
      phone: document.getElementById('custPhone'),
      notes: document.getElementById('notes'),
      btn:   document.getElementById('submitBtn'),
      toast: document.getElementById('toast'),
    };

    let products = []; // {id,name,price,enabled,seasonal,sort_order}
    let holidays = new Set();
    let cart = {};     // {productId: qty}
    let systemReady = false;

    const db = window.db;
    const GAS_ENDPOINT = window.GAS_ENDPOINT;
    const GAS_API_KEY  = window.GAS_API_KEY;

    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    async function init() {
      try {
        debugLog('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
        updateSystemStatus('ğŸ“¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ç¢ºèªä¸­...', 'loading');

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        await testFirebaseConnection();
        
        // ä¼‘æ—¥å–å¾—
        debugLog('ğŸ“… ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
        await loadHolidays();
        
        // å•†å“å–å¾—
        debugLog('ğŸ›ï¸ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
        await loadProducts();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        setupEventListeners();
        
        // ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†
        systemReady = true;
        updateSystemStatus('âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
        els.btn.disabled = false;
        els.btn.textContent = 'ğŸ“ äºˆç´„ã™ã‚‹';
        
        debugLog('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        
      } catch (error) {
        debugLog(`âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateSystemStatus(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showToast(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
      }
    }

    // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
    async function testFirebaseConnection() {
      try {
        debugLog('ğŸ”— Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±å–å¾—ãƒ†ã‚¹ãƒˆ
        const testDoc = await db.collection('products').limit(1).get();
        debugLog(`âœ… Firebaseæ¥ç¶šæˆåŠŸ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${firebase.app().options.projectId}`);
        debugLog(`ğŸ“Š æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ: ${testDoc.size}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—`);
        
      } catch (error) {
        debugLog(`âŒ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadHolidays() {
      try {
        const hs = await db.collection('holidays').get();
        holidays.clear();
        hs.forEach(d => holidays.add(d.data().date));
        debugLog(`ğŸ“… ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${holidays.size}ä»¶`);
        if (holidays.size > 0) {
          debugLog(`ä¼‘æ¥­æ—¥: ${Array.from(holidays).join(', ')}`);
        }
      } catch (error) {
        debugLog(`âš ï¸ ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        // ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªãã¦ã‚‚ç¶šè¡Œ
        debugLog('ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿ãªã—ã§ç¶šè¡Œ');
      }
    }

    // å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadProducts() {
      try {
        debugLog('ğŸ” å•†å“ãƒ‡ãƒ¼ã‚¿ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...');
        
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ãªå˜ç´”ã‚¯ã‚¨ãƒª
        debugLog('ğŸ“¦ å…¨å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹');
        const snap = await db.collection('products').get();
        
        debugLog(`ğŸ“¦ å…¨å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—: ${snap.size}ä»¶`);
        
        products = [];
        const rawProducts = [];
        
        snap.forEach(doc => {
          const productData = { id: doc.id, ...doc.data() };
          rawProducts.push(productData);
        });
        
        // JavaScriptã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆ
        products = rawProducts
          .filter(p => p.enabled === true)  // enabledã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
          .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)); // sort_orderã§ã‚½ãƒ¼ãƒˆ
        
        debugLog(`ğŸ¯ æœ‰åŠ¹å•†å“ãƒ•ã‚£ãƒ«ã‚¿çµæœ: ${products.length}ä»¶`);
        
        products.forEach((p, index) => {
          debugLog(`å•†å“${index + 1}: ${p.name} - Â¥${p.price} (é †åº:${p.sort_order})`);
        });
        
        if (products.length === 0) {
          throw new Error('æœ‰åŠ¹ãªå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        renderProducts();
        updateSystemStatus('âœ… å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', 'success');
        
      } catch (error) {
        debugLog(`âŒ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateSystemStatus(`âŒ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw error;
      }
    }

    // å•†å“ãƒªã‚¹ãƒˆæç”»
    function renderProducts() {
      try {
        debugLog('ğŸ¨ å•†å“ãƒªã‚¹ãƒˆæç”»é–‹å§‹');
        
        els.list.classList.remove('loading');
        els.list.innerHTML = '';
        
        if (products.length === 0) {
          els.list.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        products.forEach(p => {
          // ä¾¡æ ¼ãŒ0å††ã®å•†å“ã‚’é™¤å¤–
          if (p.price <= 0) {
            debugLog(`âš ï¸ ä¾¡æ ¼0å††å•†å“ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${p.name}`);
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>ğŸ ${escapeHtml(p.name)}</h3>
            <div>Â¥${p.price.toLocaleString()}</div>
            <label>æ•°é‡ 
              <input type="number" min="0" max="20" value="0" class="qty" data-id="${p.id}">
            </label>
          `;
          els.list.appendChild(card);
          debugLog(`âœ… å•†å“ã‚«ãƒ¼ãƒ‰ä½œæˆ: ${p.name}`);
        });
        
        // æ•°é‡å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        els.list.querySelectorAll('.qty').forEach(inp => {
          inp.addEventListener('input', onQuantityChange);
        });
        
        debugLog(`ğŸ¨ å•†å“ãƒªã‚¹ãƒˆæç”»å®Œäº†: ${products.length}ä»¶`);
        
      } catch (error) {
        debugLog(`âŒ å•†å“ãƒªã‚¹ãƒˆæç”»ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        els.list.innerHTML = `<div class="error-info">å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }

    // æ•°é‡å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
    function onQuantityChange(event) {
      try {
        const inp = event.target;
        const id = inp.dataset.id;
        const q = Math.max(0, Math.min(20, Number(inp.value || 0)));
        
        if (q === 0) {
          delete cart[id];
        } else {
          cart[id] = q;
        }
        
        calcTotal();
        debugLog(`ğŸ›’ å•†å“æ•°é‡å¤‰æ›´: ${id} = ${q}`);
        
      } catch (error) {
        debugLog(`âŒ æ•°é‡å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // å—å–æ—¥å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
    function onDateChange() {
      try {
        const d = els.date.value;
        const timeHelp = document.getElementById('timeHelp');
        
        debugLog(`ğŸ“… å—å–æ—¥é¸æŠ: ${d}`);
        
        // æ™‚é–“é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
        els.time.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        if (!d) {
          timeHelp.textContent = 'å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
          timeHelp.style.color = '#666';
          return;
        }
        
        if (!isBusinessDay(d, holidays)) {
          timeHelp.textContent = 'âŒ å–¶æ¥­æ—¥ï¼ˆæ°´ãƒ»åœŸï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„';
          timeHelp.style.color = '#e74c3c';
          showToast('å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
          return;
        }
        
        // å–¶æ¥­æ—¥ã®å ´åˆã€æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
        const timeSlots = genTimeSlots();
        debugLog(`â° æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ: ${timeSlots.length}ä»¶`);
        
        timeSlots.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          els.time.appendChild(opt);
        });
        
        timeHelp.textContent = 'âœ… å—å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„';
        timeHelp.style.color = '#27ae60';
        
      } catch (error) {
        debugLog(`âŒ å—å–æ—¥å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showToast(`æ—¥ä»˜å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
      }
    }

    // åˆè¨ˆé‡‘é¡è¨ˆç®—
    function calcTotal() {
      try {
        let total = 0;
        let itemCount = 0;
        
        Object.entries(cart).forEach(([pid, qty]) => {
          const p = products.find(x => x.id === pid);
          if (p) {
            total += p.price * qty;
            itemCount += qty;
          }
        });
        
        els.total.textContent = total.toLocaleString();
        debugLog(`ğŸ’° åˆè¨ˆé‡‘é¡è¨ˆç®—: Â¥${total.toLocaleString()} (${itemCount}ç‚¹)`);
        
      } catch (error) {
        debugLog(`âŒ åˆè¨ˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        els.total.textContent = '0';
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      debugLog('ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–‹å§‹');
      
      els.date.addEventListener('change', onDateChange);
      els.pm.addEventListener('change', calcTotal);
      els.btn.addEventListener('click', onSubmit);
      
      debugLog('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validate() {
      if (!systemReady) throw new Error('ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
      if (!els.date.value || !isBusinessDay(els.date.value, holidays)) throw new Error('å—å–æ—¥ãŒä¸æ­£ã§ã™ã€‚');
      if (!els.time.value) throw new Error('å—å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');

      // éå»æ—¥æ™‚ç¦æ­¢ï¼ˆJSTï¼‰
      const now = new Date(new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }));
      const pick = new Date(`${els.date.value}T${els.time.value}:00+09:00`);
      if (!(pick > now)) throw new Error('éå»ã®æ—¥æ™‚ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚');

      if (!['cash','paypay'].includes(els.pm.value)) throw new Error('æ”¯æ‰•æ–¹æ³•ãŒä¸æ­£ã§ã™ã€‚');
      if (!els.name.value.trim()) throw new Error('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(els.email.value.trim())) throw new Error('ãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™ã€‚');
      if (Object.keys(cart).length === 0) throw new Error('å•†å“æ•°é‡ã‚’1ç‚¹ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      
      debugLog('âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ');
    }

    // â˜…â˜…â˜… äºˆç´„é€ä¿¡ï¼ˆCORSå¯¾å¿œç‰ˆï¼‰â˜…â˜…â˜…
    async function onSubmit() {
      try {
        els.btn.disabled = true;
        els.btn.classList.add('loading');
        els.btn.textContent = 'ğŸ“¤ é€ä¿¡ä¸­â€¦';
        
        debugLog('ğŸ“ äºˆç´„é€ä¿¡é–‹å§‹');
        validate();

        // ã‚¢ã‚¤ãƒ†ãƒ æ•´å½¢
        const items = Object.entries(cart).map(([pid, qty]) => {
          const p = products.find(x => x.id === pid);
          return { product_id: pid, name: p.name, unit_price: p.price, qty, line_total: p.price * qty };
        });
        const total = items.reduce((a,b)=>a+b.line_total,0);

        const pickupDate = els.date.value;
        const pickupTime = els.time.value;
        const pickupTs   = firebase.firestore.Timestamp.fromDate(new Date(`${pickupDate}T${pickupTime}:00+09:00`));

        debugLog(`ğŸ“‹ äºˆç´„ãƒ‡ãƒ¼ã‚¿ä½œæˆ: ${pickupDate} ${pickupTime}, åˆè¨ˆÂ¥${total.toLocaleString()}`);

        // Firestoreã«äºˆç´„ä¿å­˜
        const payload = {
          items,
          subtotal: total, 
          total,
          payment_method: els.pm.value,
          pickup_date: pickupDate,
          pickup_time: pickupTime,
          pickup_ts: pickupTs,
          status: 'reserved',
          customer: { 
            name: els.name.value.trim(), 
            email: els.email.value.trim(),
            phone: els.phone.value.trim() || null
          },
          notes: els.notes.value.trim() || null,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        debugLog('ğŸ’¾ Firestoreä¿å­˜é–‹å§‹');
        const ref = await db.collection('reservations').add(payload);
        const reserve_no = `R-${pickupDate.replace(/-/g,'')}-${ref.id.slice(0,5)}`;
        await ref.update({ reserve_no });
        debugLog(`âœ… äºˆç´„ä¿å­˜å®Œäº†: ${reserve_no}`);

        // â˜…ä¿®æ­£: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’éåŒæœŸã§å®Ÿè¡Œï¼ˆå¤±æ•—ã—ã¦ã‚‚äºˆç´„æˆåŠŸï¼‰
        let mailStatus = { success: false, message: 'ç¢ºèªä¸­...' };
        let remindStatus = { success: false, message: 'ç¢ºèªä¸­...' };

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ä¸¦è¡Œå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
        const mailPromise = sendToGAS('mail', {
          reserve_no,
          customer: payload.customer,
          pickup: { date: pickupDate, time: pickupTime },
          items: items.map(i=>({name:i.name, qty:i.qty, unit_price:i.unit_price})),
          total, 
          payment_method: payload.payment_method
        }).then(result => {
          debugLog(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœ: ${JSON.stringify(result)}`);
          mailStatus = { 
            success: result.ok, 
            message: result.ok ? 'é€ä¿¡å®Œäº†' : `é€ä¿¡å¤±æ•—: ${result.error || 'Unknown error'}`,
            method: result.method || 'unknown'
          };
        }).catch(error => {
          debugLog(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          mailStatus = { success: false, message: `é€ä¿¡å¤±æ•—: ${error.message}` };
        });

        // ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šã‚’ä¸¦è¡Œå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
        const remindPromise = sendToGAS('remind', {
          reserve_no,
          customer: payload.customer,
          pickup: { date: pickupDate, time: pickupTime }
        }).then(result => {
          debugLog(`ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰çµæœ: ${JSON.stringify(result)}`);
          remindStatus = { 
            success: result.ok, 
            message: result.ok ? 'è¨­å®šå®Œäº†' : `è¨­å®šå¤±æ•—: ${result.error || 'Unknown error'}`,
            method: result.method || 'unknown'
          };
        }).catch(error => {
          debugLog(`ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          remindStatus = { success: false, message: `è¨­å®šå¤±æ•—: ${error.message}` };
        });

        // ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¤§10ç§’ï¼‰
        await Promise.allSettled([
          Promise.race([mailPromise, new Promise(resolve => setTimeout(resolve, 8000))]),
          Promise.race([remindPromise, new Promise(resolve => setTimeout(resolve, 8000))])
        ]);

        debugLog('ğŸ‰ äºˆç´„å‡¦ç†å®Œäº†');
        
        // äºˆç´„æˆåŠŸç”»é¢ã¸é·ç§»ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœã‚’å«ã‚€ï¼‰
        showSuccessScreenWithData({
          reserve_no,
          name: payload.customer.name,
          date: pickupDate,
          time: pickupTime,
          payment: payload.payment_method === 'cash' ? 'ç¾é‡‘' : 'PayPay',
          total: total.toLocaleString(),
          mailStatus,
          remindStatus
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        resetForm();
        
      } catch (e) {
        debugLog(`âŒ äºˆç´„é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        debugLog(`ã‚¨ãƒ©ãƒ¼è©³ç´°: ${e.stack}`, 'error');
        showToast(`äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, true);
      } finally {
        els.btn.disabled = false;
        els.btn.classList.remove('loading');
        els.btn.textContent = 'ğŸ“ äºˆç´„ã™ã‚‹';
      }
    }

    // æˆåŠŸç”»é¢è¡¨ç¤ºï¼ˆãƒ¡ãƒ¼ãƒ«çŠ¶æ…‹ä»˜ãï¼‰
    function showSuccessScreenWithData(data) {
      document.getElementById('successReserveNo').textContent = data.reserve_no;
      document.getElementById('successName').textContent = data.name;
      document.getElementById('successDateTime').textContent = `${data.date} ${data.time}`;
      document.getElementById('successPayment').textContent = data.payment;
      document.getElementById('successTotal').textContent = `Â¥${data.total}`;
      
      // ãƒ¡ãƒ¼ãƒ«çŠ¶æ…‹è¡¨ç¤º
      const mailStatusEl = document.getElementById('mailStatus');
      if (data.mailStatus) {
        if (data.mailStatus.success) {
          mailStatusEl.innerHTML = '<p style="color: #27ae60;">âœ… ã”å…¥åŠ›ã„ãŸã ã„ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚</p>';
        } else {
          mailStatusEl.innerHTML = `
            <div class="warning-notice">
              âš ï¸ ç¢ºèªãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>
              ${escapeHtml(data.mailStatus.message)}<br>
              <small>äºˆç´„ã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€ã”å®‰å¿ƒãã ã•ã„ã€‚</small>
            </div>
          `;
        }
      } else {
        mailStatusEl.innerHTML = '<p style="color: #666;">ğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ³ã‚’ç¢ºèªä¸­...</p>';
      }
      
      showSuccessScreen();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetForm() {
      cart = {};
      document.querySelectorAll('.qty').forEach(i=>i.value=0);
      calcTotal();
      els.date.value = '';
      els.time.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      els.name.value = '';
      els.email.value = '';
      els.phone.value = '';
      els.notes.value = '';
      
      // ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('dateHelp').textContent = 'å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
      document.getElementById('dateHelp').style.color = '#666';
      document.getElementById('timeHelp').textContent = 'å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
      document.getElementById('timeHelp').style.color = '#666';
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(msg, isErr=false, isWarning=false) {
      els.toast.textContent = msg;
      els.toast.classList.remove('hidden');
      els.toast.className = 'toast' + (isErr ? ' error' : isWarning ? ' warning' : '');
      setTimeout(()=>{ els.toast.classList.add('hidden'); }, 8000);
      
      debugLog(`ğŸ“¢ ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º: ${msg}`, isErr ? 'error' : 'info');
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
      init().catch(e => {
        debugLog(`ğŸ’¥ åˆæœŸåŒ–å¤±æ•—: ${e.message}`, 'error');
        showToast(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, true);
      });
    });
  </script>
</body>
</html>