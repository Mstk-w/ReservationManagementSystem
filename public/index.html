<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥äºˆç´„ï¼ˆCORSè§£æ±ºç‰ˆï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh; line-height: 1.6; color: #333;
    }
    .container { 
      max-width: 900px; margin: 24px auto; padding: 20px; 
      background: #fff; border-radius: 16px; 
      box-shadow: 0 10px 40px rgba(0,0,0,.1); 
    }
    h1 {
      text-align: center; font-size: 2.4rem; margin-bottom: 30px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; font-weight: 700;
    }
    h2 {
      font-size: 1.6rem; color: #4a5568; border-bottom: 3px solid #e2e8f0;
      padding-bottom: 12px; margin: 32px 0 20px; position: relative;
    }
    h2::before {
      content: ''; position: absolute; bottom: -3px; left: 0; width: 60px; height: 3px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    }
    label { 
      display: block; margin: 16px 0 8px; font-weight: 600; color: #2d3748; font-size: 14px;
    }
    input, select {
      width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 10px;
      font-size: 16px; margin-top: 6px; transition: all 0.3s ease; font-family: inherit;
      background: #fafafa;
    }
    input:focus, select:focus {
      outline: none; border-color: #667eea; background: #fff;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); transform: translateY(-1px);
    }
    small { display: block; margin-top: 6px; font-size: 12px; color: #718096; line-height: 1.4; }
    section {
      margin: 32px 0; padding: 24px; background: #f7fafc; border-radius: 12px;
      border: 1px solid #e2e8f0; position: relative; overflow: hidden;
    }
    section::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    }
    .grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 16px; margin-top: 20px;
    }
    .card { 
      border: 2px solid #e2e8f0; padding: 20px; border-radius: 12px; 
      background: white; transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(45deg, #48bb78 0%, #38a169 100%);
      transform: scaleX(0); transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    .card:hover::before { transform: scaleX(1); }
    .card h3 { margin: 0 0 12px; font-size: 18px; color: #2d3748; font-weight: 600; }
    .card > div { color: #4a5568; font-size: 16px; margin-bottom: 16px; font-weight: 500; }
    .qty { width: 80px; text-align: center; margin-top: 8px; font-weight: 600; }
    .total { 
      font-size: 24px; font-weight: 700; margin-top: 20px; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border-radius: 12px; text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button { 
      width: 100%; padding: 18px 32px; border: none; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: 600;
      margin-top: 32px; transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    button:disabled { 
      background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none;
    }
    button.loading { position: relative; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; top: 50%; left: 50%; 
      transform: translate(-50%, -50%); width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .toast { 
      margin-top: 20px; padding: 16px 20px; border-radius: 10px; font-weight: 500;
      border-left: 4px solid; animation: slideIn 0.3s ease-out;
    }
    .toast:not(.error):not(.warning) { 
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      color: #22543d; border-left-color: #38a169;
    }
    .toast.error { 
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      color: #742a2a; border-left-color: #e53e3e;
    }
    .toast.warning { 
      background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
      color: #744210; border-left-color: #d69e2e;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    .status-card {
      background: white; border-radius: 10px; padding: 16px; margin: 16px 0;
      border-left: 4px solid; font-weight: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .status-loading {
      border-left-color: #3182ce;
      background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); color: #2c5282;
    }
    .status-success {
      border-left-color: #38a169;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); color: #22543d;
    }
    .status-error {
      border-left-color: #e53e3e;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); color: #742a2a;
    }

    /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
    .debug-info {
      background: #f7fafc; border: 2px solid #e2e8f0; padding: 20px; margin: 20px 0;
      border-radius: 10px; font-size: 12px; color: #4a5568; max-height: 400px; overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    .debug-info h3 { margin: 0 0 16px; color: #2d3748; font-size: 16px; font-family: inherit; }
    .debug-info .log-entry {
      margin: 6px 0; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.6);
      border-left: 3px solid #e2e8f0; font-size: 11px; line-height: 1.4;
    }
    .debug-info .log-entry.error { border-left-color: #e53e3e; background: rgba(254, 178, 178, 0.3); }
    .debug-info .log-entry.warn { border-left-color: #d69e2e; background: rgba(250, 240, 137, 0.3); }

    /* äºˆç´„å®Œäº†ç”»é¢ */
    .success-screen {
      text-align: center; padding: 40px 20px;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
      border-radius: 16px; border: 3px solid #38a169; margin: 20px 0;
      animation: fadeIn 0.6s ease-out;
    }
    .success-icon {
      font-size: 4rem; color: #38a169; margin-bottom: 20px; display: block;
      animation: bounce 0.8s ease-out;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .success-screen h2 {
      color: #22543d; font-size: 2.2rem; margin-bottom: 20px; border: none;
    }
    .reservation-details {
      background: white; padding: 24px; border-radius: 12px; margin: 24px 0;
      border: 2px solid #c6f6d5; text-align: left;
    }
    .detail-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid #e2e8f0;
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 600; color: #2d3748; }
    .detail-value { color: #4a5568; font-weight: 500; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .container { margin: 12px; padding: 16px; }
      h1 { font-size: 2rem; }
      .grid { grid-template-columns: 1fr; }
      .detail-row { flex-direction: column; align-items: flex-start; gap: 6px; }
    }

    .hidden { display: none; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <main class="container">
    <!-- äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ -->
    <div id="reservationForm">
      <h1>ğŸ ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥å—å–äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h1>

      <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
      <div id="systemStatus" class="status-card status-loading">
        ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­... (CORSå›é¿ãƒ¢ãƒ¼ãƒ‰)
      </div>

      <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰-->
      <div id="debugInfo" class="debug-info hidden">
        <h3>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­æƒ…å ±</h3>
        <div id="debugContent"></div>
      </div>

      <section>
        <h2>ğŸ“… å—å–æ—¥æ™‚ã®é¸æŠ</h2>
        <label>å—å–æ—¥ï¼ˆæ°´ãƒ»åœŸã®ã¿ï¼‰<span style="color: #e53e3e;">*</span>
          <input type="date" id="pickupDate" required />
          <small id="dateHelp">å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </label>
        
        <label>å—å–æ™‚é–“ï¼ˆ11:00â€“17:00ï¼‰<span style="color: #e53e3e;">*</span>
          <select id="pickupTime" required>
            <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
          <small id="timeHelp">å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </label>
        
        <label>æ”¯æ‰•æ–¹æ³•<span style="color: #e53e3e;">*</span>
          <select id="paymentMethod" required>
            <option value="cash">ğŸ’° ç¾é‡‘</option>
            <option value="paypay">ğŸ“± PayPay</option>
          </select>
          <small>åº—é ­ã§ã®ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </label>
      </section>

      <section>
        <h2>ğŸ›’ å•†å“ã‚’é¸æŠ</h2>
        <div id="productStatus" class="status-card status-loading">ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="productList" class="grid"></div>
        <div class="total">åˆè¨ˆ: Â¥<span id="total">0</span></div>
      </section>

      <section>
        <h2>ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±</h2>
        <label>ãŠåå‰<span style="color: #e53e3e;">*</span>
          <input id="custName" placeholder="å±±ç”°å¤ªéƒ" required />
          <small>ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§ã”å…¥åŠ›ãã ã•ã„</small>
        </label>
        
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span style="color: #e53e3e;">*</span>
          <input id="custEmail" type="email" placeholder="taro@example.com" required />
          <small>ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã™ã®ã§ã€æ­£ç¢ºã«ã”å…¥åŠ›ãã ã•ã„</small>
        </label>
        
        <label>é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰
          <input id="custPhone" type="tel" placeholder="090-1234-5678" />
          <small>ç·Šæ€¥é€£çµ¡æ™‚ã«ã®ã¿ä½¿ç”¨ã„ãŸã—ã¾ã™</small>
        </label>
        
        <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰
          <input id="notes" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚„ã”è¦æœ›ãªã©ã”ã–ã„ã¾ã—ãŸã‚‰ã”è¨˜å…¥ãã ã•ã„" />
          <small>ç‰¹åˆ¥ãªã”è¦æœ›ãŒã‚ã‚Œã°ãŠæ›¸ããã ã•ã„</small>
        </label>
      </section>

      <button id="submitBtn" disabled>ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</button>
      
      <div id="toast" class="toast hidden"></div>

      <!-- ãƒ‡ãƒãƒƒã‚°åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
      <div class="text-center" style="margin-top: 20px;">
        <button type="button" onclick="toggleDebug()" style="width: auto; padding: 8px 16px; font-size: 12px; background: #718096;">
          ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        </button>
      </div>
    </div>

    <!-- äºˆç´„å®Œäº†ç”»é¢ -->
    <div id="successScreen" class="hidden">
      <div class="success-screen">
        <span class="success-icon">âœ…</span>
        <h2>äºˆç´„å®Œäº†ã„ãŸã—ã¾ã—ãŸï¼</h2>
        <p>ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã§æ‰¿ã‚Šã¾ã—ãŸã€‚</p>
        
        <div class="reservation-details">
          <h3>ğŸ“‹ äºˆç´„è©³ç´°</h3>
          <div class="detail-row">
            <span class="detail-label">äºˆç´„ç•ªå·:</span>
            <span class="detail-value" id="successReserveNo">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ãŠåå‰:</span>
            <span class="detail-value" id="successName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">å—å–æ—¥æ™‚:</span>
            <span class="detail-value" id="successDateTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ãŠæ”¯æ‰•ã„:</span>
            <span class="detail-value" id="successPayment">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">åˆè¨ˆé‡‘é¡:</span>
            <span class="detail-value" id="successTotal">-</span>
          </div>
        </div>

        <div class="reservation-details">
          <h3>ğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«</h3>
          <div id="mailStatus">ğŸ“® ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ³ã‚’ç¢ºèªä¸­...</div>
        </div>

        <div class="reservation-details">
          <h3>ğŸ“ åº—èˆ—æƒ…å ±</h3>
          <p><strong>å—å–å ´æ‰€:</strong> ã‚«ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥</p>
          <p><strong>å–¶æ¥­æ—¥:</strong> æ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥</p>
          <p><strong>å–¶æ¥­æ™‚é–“:</strong> 11:00ï½17:00</p>
          <div style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 14px; color: #4a5568;">
            âš ï¸ <strong>é‡è¦:</strong> å½“æ—¥ãŠæ°—ã‚’ã¤ã‘ã¦ãŠè¶Šã—ãã ã•ã„<br>
            ğŸ’¡ ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã®é€£çµ¡å…ˆã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„
          </div>
        </div>

        <button onclick="backToForm()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
          ğŸ”™ æ–°ã—ã„äºˆç´„ã‚’ã™ã‚‹
        </button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // â˜…â˜…â˜… ã‚·ã‚¹ãƒ†ãƒ è¨­å®š â˜…â˜…â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyC7e6YZSeh1RYBdWEfob6xT7XnxBIZu2Uw",
      authDomain: "hyggelyreservationsystem.firebaseapp.com",
      projectId: "hyggelyreservationsystem",
      storageBucket: "hyggelyreservationsystem.firebasestorage.app",
      messagingSenderId: "549459143900",
      appId: "1:549459143900:web:7d9f2bb6ddc22573869819"
    };

    // â˜…â˜…â˜… GASè¨­å®šï¼ˆå®Ÿéš›ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰â˜…â˜…â˜…
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyC-0emy2ecJnc8cSFCWIOuPpr41cNr8yWjj2-bZ8i6_3-fu45-Q1ys9R2IQUIhkihD/exec";
    const GAS_API_KEY = "91d012136acf47f0b65ca8f84aceced56af240e21d3f42878f6e535dfe03a625";

    // â˜…â˜…â˜… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° â˜…â˜…â˜…
    let debugMode = false;
    let systemLogs = [];
    let db;
    let systemReady = false;
    let products = [];
    let holidays = new Set();
    let cart = {};

    // DOMè¦ç´ 
    const elements = {
      date: document.getElementById('pickupDate'),
      time: document.getElementById('pickupTime'),
      payment: document.getElementById('paymentMethod'),
      productList: document.getElementById('productList'),
      total: document.getElementById('total'),
      custName: document.getElementById('custName'),
      custEmail: document.getElementById('custEmail'),
      custPhone: document.getElementById('custPhone'),
      notes: document.getElementById('notes'),
      submitBtn: document.getElementById('submitBtn'),
      toast: document.getElementById('toast')
    };

    // â˜…â˜…â˜… ãƒ­ã‚°ãƒ»ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ â˜…â˜…â˜…
    function log(message, level = 'info') {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const logEntry = { time: timestamp, level: level, message: String(message), timestamp: Date.now() };
      systemLogs.push(logEntry);
      console.log(`[${level.toUpperCase()}] ${timestamp}: ${message}`);
      if (systemLogs.length > 100) systemLogs = systemLogs.slice(-80);
      if (debugMode) updateDebugDisplay();
    }
    
    function updateDebugDisplay() {
      const debugContent = document.getElementById('debugContent');
      if (!debugContent) return;
      const recentLogs = systemLogs.slice(-30);
      debugContent.innerHTML = recentLogs.map(entry => {
        const levelClass = entry.level === 'error' ? 'error' : entry.level === 'warn' ? 'warn' : '';
        return `<div class="log-entry ${levelClass}">[${entry.time}] ${escapeHtml(entry.message)}</div>`;
      }).join('');
      debugContent.scrollTop = debugContent.scrollHeight;
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.classList.toggle('hidden', !debugMode);
        if (debugMode) updateDebugDisplay();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('systemStatus');
      const productStatusEl = document.getElementById('productStatus');
      
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `status-card status-${type}`;
      }
      
      if (productStatusEl && type !== 'loading') {
        productStatusEl.textContent = type === 'success' ? 'âœ… å•†å“ä¸€è¦§' : message;
        productStatusEl.className = `status-card status-${type}`;
      }
      
      log(`Status: ${message} (${type})`);
    }

    // â˜…â˜…â˜… FirebaseåˆæœŸåŒ– â˜…â˜…â˜…
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      log('FirebaseåˆæœŸåŒ–å®Œäº†');
    } catch (error) {
      log(`FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      updateStatus('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }

    // â˜…â˜…â˜… CORSå®Œå…¨å›é¿ GASé€šä¿¡æ©Ÿèƒ½ â˜…â˜…â˜…
    let requestCounter = 0;

    function sendToGAS_JSONP(path, data) {
      return new Promise((resolve) => {
        try {
          log(`JSONPé€šä¿¡é–‹å§‹: ${path}`);
          
          const callbackName = `gasCallback_${Date.now()}_${++requestCounter}`;
          const timeoutId = setTimeout(() => {
            cleanup();
            log('JSONPé€šä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', 'warn');
            resolve({
              ok: false,
              method: 'jsonp_timeout',
              message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'
            });
          }, 15000);
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä½œæˆ
          window[callbackName] = (response) => {
            cleanup();
            log('JSONPé€šä¿¡æˆåŠŸ');
            resolve({
              ...response,
              method: 'jsonp_success'
            });
          };
          
          function cleanup() {
            clearTimeout(timeoutId);
            if (window[callbackName]) {
              delete window[callbackName];
            }
            const existingScript = document.getElementById(callbackName);
            if (existingScript) {
              existingScript.remove();
            }
          }
          
          // ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLæ§‹ç¯‰
          const params = new URLSearchParams({
            key: GAS_API_KEY,
            path: path,
            data: JSON.stringify(data),
            callback: callbackName
          });
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ä½œæˆãƒ»å®Ÿè¡Œ
          const script = document.createElement('script');
          script.id = callbackName;
          script.src = `${GAS_ENDPOINT}?${params.toString()}`;
          script.onerror = () => {
            cleanup();
            log('JSONPé€šä¿¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼', 'error');
            resolve({
              ok: false,
              method: 'jsonp_script_error',
              message: 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'
            });
          };
          
          document.head.appendChild(script);
          
        } catch (error) {
          log(`JSONPé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          resolve({
            ok: false,
            method: 'jsonp_exception',
            error: error.message
          });
        }
      });
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function sendToGAS_Form(path, data) {
      return new Promise((resolve) => {
        try {
          log(`ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é€šä¿¡é–‹å§‹: ${path}`);
          
          // éš ã—iframeä½œæˆ
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.name = `gasFrame_${Date.now()}`;
          
          // ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = GAS_ENDPOINT;
          form.target = iframe.name;
          
          // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
          const params = {
            key: GAS_API_KEY,
            path: path,
            data: JSON.stringify(data)
          };
          
          Object.entries(params).forEach(([key, value]) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
          });
          
          // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
          const timeoutId = setTimeout(() => {
            cleanup();
            log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', 'warn');
            resolve({
              ok: false,
              method: 'form_timeout',
              message: 'ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'
            });
          }, 10000);
          
          iframe.onload = () => {
            cleanup();
            log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å®Œäº†');
            resolve({
              ok: true,
              method: 'form_success',
              message: 'ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ'
            });
          };
          
          function cleanup() {
            clearTimeout(timeoutId);
            if (iframe.parentNode) iframe.remove();
            if (form.parentNode) form.remove();
          }
          
          // å®Ÿè¡Œ
          document.body.appendChild(iframe);
          document.body.appendChild(form);
          form.submit();
          
        } catch (error) {
          log(`ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          resolve({
            ok: false,
            method: 'form_exception',
            error: error.message
          });
        }
      });
    }

    // ãƒ¡ã‚¤ãƒ³é€šä¿¡é–¢æ•°ï¼ˆè¤‡æ•°æ‰‹æ³•ä½µç”¨ï¼‰
    async function sendToGAS(path, data, maxRetries = 2) {
      const methods = [
        () => sendToGAS_JSONP(path, data),
        () => sendToGAS_Form(path, data)
      ];
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        for (const [index, method] of methods.entries()) {
          try {
            log(`é€šä¿¡è©¦è¡Œ ${attempt}/${maxRetries}, æ‰‹æ³• ${index + 1}/${methods.length}`);
            const result = await method();
            
            if (result.ok) {
              log(`é€šä¿¡æˆåŠŸ: ${path} (${result.method})`);
              return result;
            } else {
              log(`é€šä¿¡å¤±æ•—: ${result.message} (${result.method})`, 'warn');
            }
            
          } catch (error) {
            log(`é€šä¿¡ä¾‹å¤–: ${error.message}`, 'error');
          }
        }
        
        if (attempt < maxRetries) {
          log(`${1000 * attempt}ms å¾…æ©Ÿå¾Œã«ãƒªãƒˆãƒ©ã‚¤`);
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
      
      log(`å…¨é€šä¿¡æ‰‹æ³•ãŒå¤±æ•—: ${path}`, 'error');
      return {
        ok: false,
        method: 'all_failed',
        message: 'ã™ã¹ã¦ã®é€šä¿¡æ–¹æ³•ãŒå¤±æ•—ã—ã¾ã—ãŸ'
      };
    }

    // â˜…â˜…â˜… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•° â˜…â˜…â˜…
    function isBusinessDay(dateStr, holidaysSet) {
      try {
        const d = new Date(dateStr + 'T00:00:00+09:00');
        const dayOfWeek = d.getDay();
        if (holidaysSet && holidaysSet.has(dateStr)) {
          log(`${dateStr} ã¯è‡¨æ™‚ä¼‘æ¥­æ—¥ã§ã™`);
          return false;
        }
        const isBusiness = dayOfWeek === 3 || dayOfWeek === 6;
        log(`${dateStr} æ›œæ—¥:${dayOfWeek} å–¶æ¥­æ—¥:${isBusiness}`);
        return isBusiness;
      } catch (error) {
        log(`å–¶æ¥­æ—¥åˆ¤å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return false;
      }
    }

    function generateTimeSlots(start = "11:00", end = "17:00", intervalMin = 30) {
      try {
        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);
        const startMinutes = startH * 60 + startM;
        const endMinutes = endH * 60 + endM;
        
        const slots = [];
        for (let minutes = startMinutes; minutes <= endMinutes; minutes += intervalMin) {
          const hours = String(Math.floor(minutes / 60)).padStart(2, '0');
          const mins = String(minutes % 60).padStart(2, '0');
          slots.push(`${hours}:${mins}`);
        }
        
        log(`æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ: ${slots.length}å€‹ (${slots[0]} - ${slots[slots.length-1]})`);
        return slots;
      } catch (error) {
        log(`æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return [];
      }
    }

    // â˜…â˜…â˜… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ– â˜…â˜…â˜…
    async function initializeSystem() {
      try {
        log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹ (CORSå›é¿ãƒ¢ãƒ¼ãƒ‰)');
        updateStatus('ğŸ”— ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'loading');
        
        await testFirebaseConnection();
        
        log('ğŸ“… ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
        await loadHolidays();
        
        log('ğŸ›ï¸ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
        await loadProducts();
        
        setupEventListeners();
        
        systemReady = true;
        updateStatus('âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº† (CORSå›é¿ãƒ¢ãƒ¼ãƒ‰)', 'success');
        elements.submitBtn.disabled = false;
        elements.submitBtn.textContent = 'ğŸ“ äºˆç´„ã‚’ç¢ºå®šã™ã‚‹';
        
        log('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        showToast('ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã”äºˆç´„ã‚’ãŠé€²ã‚ãã ã•ã„ã€‚', false);
        
      } catch (error) {
        log(`âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateStatus(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showToast(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
      }
    }

    async function testFirebaseConnection() {
      try {
        log('ğŸ” Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        const testQuery = await db.collection('products').limit(1).get();
        log(`âœ… Firebaseæ¥ç¶šæˆåŠŸ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${firebase.app().options.projectId}`);
        log(`ğŸ“Š ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªçµæœ: ${testQuery.size}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ`);
      } catch (error) {
        log(`âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—: ${error.message}`);
      }
    }

    async function loadHolidays() {
      try {
        const snapshot = await db.collection('holidays').get();
        holidays.clear();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.date) holidays.add(data.date);
        });
        log(`ğŸ“… ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${holidays.size}ä»¶`);
        if (holidays.size > 0) {
          log(`ä¼‘æ¥­æ—¥ãƒªã‚¹ãƒˆ: ${Array.from(holidays).join(', ')}`);
        }
      } catch (error) {
        log(`âš ï¸ ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        log('ä¼‘æ¥­æ—¥ãƒ‡ãƒ¼ã‚¿ãªã—ã§ç¶šè¡Œã—ã¾ã™');
      }
    }

    async function loadProducts() {
      try {
        log('ğŸ” å•†å“ãƒ‡ãƒ¼ã‚¿ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...');
        updateStatus('ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
        
        const snapshot = await db.collection('products').get();
        log(`ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—: ${snapshot.size}ä»¶`);
        
        const allProducts = [];
        snapshot.forEach(doc => {
          allProducts.push({ id: doc.id, ...doc.data() });
        });
        
        products = allProducts
          .filter(p => p.enabled === true)
          .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
        
        log(`ğŸ¯ æœ‰åŠ¹å•†å“: ${products.length}ä»¶`);
        
        if (products.length === 0) {
          throw new Error('æœ‰åŠ¹ãªå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        renderProducts();
        updateStatus('âœ… å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', 'success');
        
      } catch (error) {
        log(`âŒ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateStatus(`âŒ å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw error;
      }
    }

    function renderProducts() {
      try {
        log('ğŸ¨ å•†å“ãƒªã‚¹ãƒˆæç”»é–‹å§‹');
        elements.productList.innerHTML = '';
        
        if (products.length === 0) {
          elements.productList.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
              ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
          `;
          return;
        }
        
        products.forEach(product => {
          if (product.price <= 0) {
            log(`âš ï¸ ä¾¡æ ¼0å††å•†å“ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${product.name}`);
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>ğŸ ${escapeHtml(product.name)}</h3>
            <div>Â¥${product.price.toLocaleString()}</div>
            <label>æ•°é‡ 
              <input type="number" min="0" max="20" value="0" class="qty" data-id="${product.id}">
            </label>
          `;
          
          elements.productList.appendChild(card);
          log(`âœ… å•†å“ã‚«ãƒ¼ãƒ‰ä½œæˆ: ${product.name}`);
        });
        
        elements.productList.querySelectorAll('.qty').forEach(input => {
          input.addEventListener('input', handleQuantityChange);
        });
        
        log(`ğŸ¨ å•†å“ãƒªã‚¹ãƒˆæç”»å®Œäº†: ${products.length}ä»¶`);
        
      } catch (error) {
        log(`âŒ å•†å“ãƒªã‚¹ãƒˆæç”»ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        elements.productList.innerHTML = `
          <div style="grid-column: 1/-1;" class="status-card status-error">
            å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${escapeHtml(error.message)}
          </div>
        `;
      }
    }

    function setupEventListeners() {
      log('ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–‹å§‹');
      elements.date.addEventListener('change', handleDateChange);
      elements.payment.addEventListener('change', calculateTotal);
      elements.submitBtn.addEventListener('click', handleSubmit);
      log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    }

    function handleDateChange() {
      try {
        const selectedDate = elements.date.value;
        const timeHelp = document.getElementById('timeHelp');
        
        log(`ğŸ“… å—å–æ—¥é¸æŠ: ${selectedDate}`);
        
        elements.time.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        if (!selectedDate) {
          timeHelp.textContent = 'å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
          timeHelp.style.color = '#718096';
          return;
        }
        
        if (!isBusinessDay(selectedDate, holidays)) {
          timeHelp.textContent = 'âŒ å–¶æ¥­æ—¥ï¼ˆæ°´ãƒ»åœŸï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„';
          timeHelp.style.color = '#e53e3e';
          showToast('å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
          return;
        }
        
        const timeSlots = generateTimeSlots();
        log(`â° æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ: ${timeSlots.length}å€‹`);
        
        timeSlots.forEach(timeSlot => {
          const option = document.createElement('option');
          option.value = timeSlot;
          option.textContent = timeSlot;
          elements.time.appendChild(option);
        });
        
        timeHelp.textContent = 'âœ… å—å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„';
        timeHelp.style.color = '#38a169';
        
      } catch (error) {
        log(`âŒ å—å–æ—¥å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showToast(`æ—¥ä»˜å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
      }
    }

    function handleQuantityChange(event) {
      try {
        const input = event.target;
        const productId = input.dataset.id;
        const quantity = Math.max(0, Math.min(20, Number(input.value || 0)));
        
        input.value = quantity;
        
        if (quantity === 0) {
          delete cart[productId];
        } else {
          cart[productId] = quantity;
        }
        
        calculateTotal();
        log(`ğŸ›’ å•†å“æ•°é‡å¤‰æ›´: ${productId} = ${quantity}`);
        
      } catch (error) {
        log(`âŒ æ•°é‡å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    function calculateTotal() {
      try {
        let totalAmount = 0;
        let totalItems = 0;
        
        Object.entries(cart).forEach(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          if (product) {
            totalAmount += product.price * quantity;
            totalItems += quantity;
          }
        });
        
        elements.total.textContent = totalAmount.toLocaleString();
        log(`ğŸ’° åˆè¨ˆé‡‘é¡: Â¥${totalAmount.toLocaleString()} (${totalItems}ç‚¹)`);
        
      } catch (error) {
        log(`âŒ åˆè¨ˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        elements.total.textContent = '0';
      }
    }

    function validateForm() {
      if (!systemReady) throw new Error('ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„');
      if (!elements.date.value || !isBusinessDay(elements.date.value, holidays)) throw new Error('æœ‰åŠ¹ãªå—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      if (!elements.time.value) throw new Error('å—å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      
      const now = new Date();
      const pickupDateTime = new Date(`${elements.date.value}T${elements.time.value}:00+09:00`);
      if (pickupDateTime <= now) throw new Error('éå»ã®æ—¥æ™‚ã¯é¸æŠã§ãã¾ã›ã‚“');
      
      if (!['cash', 'paypay'].includes(elements.payment.value)) throw new Error('æ”¯æ‰•æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
      if (!elements.custName.value.trim()) throw new Error('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      const email = elements.custEmail.value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      if (Object.keys(cart).length === 0) throw new Error('å•†å“ã‚’1ç‚¹ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
      
      log('âœ… ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ');
    }

    async function handleSubmit() {
      try {
        log('ğŸ“ äºˆç´„é€ä¿¡å‡¦ç†é–‹å§‹');
        
        elements.submitBtn.disabled = true;
        elements.submitBtn.classList.add('loading');
        elements.submitBtn.textContent = '';
        
        validateForm();
        
        const orderItems = Object.entries(cart).map(([productId, quantity]) => {
          const product = products.find(p => p.id === productId);
          return {
            product_id: productId,
            name: product.name,
            unit_price: product.price,
            qty: quantity,
            line_total: product.price * quantity
          };
        });
        
        const totalAmount = orderItems.reduce((sum, item) => sum + item.line_total, 0);
        
        const reservationData = {
          items: orderItems,
          subtotal: totalAmount,
          total: totalAmount,
          payment_method: elements.payment.value,
          pickup_date: elements.date.value,
          pickup_time: elements.time.value,
          pickup_ts: firebase.firestore.Timestamp.fromDate(
            new Date(`${elements.date.value}T${elements.time.value}:00+09:00`)
          ),
          status: 'reserved',
          customer: {
            name: elements.custName.value.trim(),
            email: elements.custEmail.value.trim(),
            phone: elements.custPhone.value.trim() || null
          },
          notes: elements.notes.value.trim() || null,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        log(`ğŸ“‹ äºˆç´„ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†: ${elements.date.value} ${elements.time.value}, åˆè¨ˆÂ¥${totalAmount.toLocaleString()}`);
        
        log('ğŸ’¾ Firestoreä¿å­˜é–‹å§‹');
        const docRef = await db.collection('reservations').add(reservationData);
        const reserveNo = `R-${elements.date.value.replace(/-/g,'')}-${docRef.id.slice(0,5)}`;
        await docRef.update({ reserve_no: reserveNo });
        
        log(`âœ… äºˆç´„ä¿å­˜å®Œäº†: ${reserveNo}`);
        
        let mailResult = { success: false, message: 'é€ä¿¡ä¸­...' };
        let reminderResult = { success: false, message: 'è¨­å®šä¸­...' };
        
        // GAS APIä¸¦è¡Œå‘¼ã³å‡ºã—
        const gasRequests = [
          sendToGAS('mail', {
            reserve_no: reserveNo,
            customer: reservationData.customer,
            pickup: { 
              date: reservationData.pickup_date, 
              time: reservationData.pickup_time 
            },
            items: orderItems,
            total: totalAmount,
            payment_method: reservationData.payment_method
          }).then(result => {
            mailResult = {
              success: result.ok,
              message: result.ok ? 'é€ä¿¡å®Œäº†' : `é€ä¿¡å¤±æ•—: ${result.message || 'Unknown error'}`,
              method: result.method || 'unknown'
            };
            log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœ: ${JSON.stringify(mailResult)}`);
          }).catch(error => {
            mailResult = { success: false, message: `é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}` };
            log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          }),
          
          sendToGAS('remind', {
            reserve_no: reserveNo,
            customer: reservationData.customer,
            pickup: { 
              date: reservationData.pickup_date, 
              time: reservationData.pickup_time 
            }
          }).then(result => {
            reminderResult = {
              success: result.ok,
              message: result.ok ? 'è¨­å®šå®Œäº†' : `è¨­å®šå¤±æ•—: ${result.message || 'Unknown error'}`,
              method: result.method || 'unknown'
            };
            log(`ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼çµæœ: ${JSON.stringify(reminderResult)}`);
          }).catch(error => {
            reminderResult = { success: false, message: `è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}` };
            log(`ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          })
        ];
        
        await Promise.allSettled([
          Promise.race([
            Promise.all(gasRequests),
            new Promise(resolve => setTimeout(resolve, 15000))
          ])
        ]);
        
        log('ğŸ‰ äºˆç´„å‡¦ç†å®Œäº†');
        
        showSuccessScreen({
          reserveNo: reserveNo,
          customerName: reservationData.customer.name,
          pickupDate: reservationData.pickup_date,
          pickupTime: reservationData.pickup_time,
          paymentMethod: reservationData.payment_method === 'cash' ? 'ç¾é‡‘' : 'PayPay',
          totalAmount: totalAmount.toLocaleString(),
          mailResult: mailResult,
          reminderResult: reminderResult
        });
        
        resetForm();
        
      } catch (error) {
        log(`âŒ äºˆç´„é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showToast(`äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
        
      } finally {
        elements.submitBtn.disabled = false;
        elements.submitBtn.classList.remove('loading');
        elements.submitBtn.textContent = 'ğŸ“ äºˆç´„ã‚’ç¢ºå®šã™ã‚‹';
      }
    }

    function showSuccessScreen(data) {
      document.getElementById('successReserveNo').textContent = data.reserveNo;
      document.getElementById('successName').textContent = data.customerName;
      document.getElementById('successDateTime').textContent = `${data.pickupDate} ${data.pickupTime}`;
      document.getElementById('successPayment').textContent = data.paymentMethod;
      document.getElementById('successTotal').textContent = `Â¥${data.totalAmount}`;
      
      const mailStatusEl = document.getElementById('mailStatus');
      if (data.mailResult && data.mailResult.success) {
        mailStatusEl.innerHTML = `
          <div style="color: #22543d; font-weight: 500;">
            âœ… ã”å…¥åŠ›ã„ãŸã ã„ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸ
          </div>
        `;
      } else {
        mailStatusEl.innerHTML = `
          <div style="color: #d69e2e; padding: 12px; background: #fefcbf; border-radius: 8px; border: 1px solid #f6e05e;">
            âš ï¸ ç¢ºèªãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ<br>
            ${escapeHtml(data.mailResult?.message || 'é€ä¿¡çŠ¶æ³ä¸æ˜')}<br>
            <small style="color: #744210;">â€»äºˆç´„ã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€ã”å®‰å¿ƒãã ã•ã„</small>
          </div>
        `;
      }
      
      document.getElementById('reservationForm').classList.add('hidden');
      document.getElementById('successScreen').classList.remove('hidden');
      window.scrollTo(0, 0);
    }
    
    function backToForm() {
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('reservationForm').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    function resetForm() {
      cart = {};
      document.querySelectorAll('.qty').forEach(input => input.value = 0);
      calculateTotal();
      
      elements.date.value = '';
      elements.time.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      elements.custName.value = '';
      elements.custEmail.value = '';
      elements.custPhone.value = '';
      elements.notes.value = '';
      
      const dateHelp = document.getElementById('dateHelp');
      const timeHelp = document.getElementById('timeHelp');
      if (dateHelp) {
        dateHelp.textContent = 'å–¶æ¥­æ—¥ï¼ˆæ°´æ›œæ—¥ãƒ»åœŸæ›œæ—¥ï¼‰ã‹ã¤è‡¨æ™‚ä¼‘æ¥­æ—¥ä»¥å¤–ã‚’é¸æŠã—ã¦ãã ã•ã„';
        dateHelp.style.color = '#718096';
      }
      if (timeHelp) {
        timeHelp.textContent = 'å…ˆã«å—å–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
        timeHelp.style.color = '#718096';
      }
    }

    function showToast(message, isError = false, duration = 8000) {
      elements.toast.textContent = message;
      elements.toast.classList.remove('hidden');
      elements.toast.className = `toast ${isError ? 'error' : ''}`;
      
      setTimeout(() => {
        elements.toast.classList.add('hidden');
      }, duration);
      
      log(`ğŸ“¢ ãƒˆãƒ¼ã‚¹ãƒˆ: ${message}`, isError ? 'error' : 'info');
    }

    // ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº† - CORSå›é¿ãƒ¢ãƒ¼ãƒ‰');
      initializeSystem().catch(error => {
        log(`ğŸ’¥ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
        showToast(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
      });
    });
  </script>
</body>
</html>